<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Master V4 - Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --sidebar-width: 260px;
            --card-bg: #fff;
            --body-bg: #f0f2f5;
            --glass: rgba(255, 255, 255, 0.05);
        }

        [data-bs-theme="dark"] {
            --card-bg: #1e1e2d;
            --body-bg: #151521;
            --glass: rgba(0, 0, 0, 0.2);
        }

        body {
            background-color: var(--body-bg);
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow-x: hidden;
            transition: background 0.3s ease;
        }

        /* Glassmorphism Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: #1a1a27;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 1000;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #content {
            margin-left: var(--sidebar-width);
            padding: 30px;
            width: calc(100% - var(--sidebar-width));
            transition: 0.3s;
        }

        /* Mobile Overlay */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 900;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
            backdrop-filter: blur(4px);
        }

        #overlay.active {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 768px) {
            #sidebar {
                left: -280px;
                box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
            }

            #sidebar.active {
                left: 0;
            }

            #content {
                margin-left: 0;
                padding: 15px;
                width: 100%;
            }
        }

        /* Nav Links Animados */
        .nav-link {
            color: #a2a3b7;
            padding: 12px 20px;
            margin: 5px 15px;
            border-radius: 10px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(90deg, #0d6efd 0%, #0099ff 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
        }

        /* Cards con Hover */
        .card-custom {
            border: none;
            border-radius: 15px;
            background-color: var(--card-bg);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.03);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* Tablas Bonitas */
        .table-row-anim {
            animation: fadeInUp 0.5s ease backwards;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
            transform: scale(1.005);
            transition: 0.2s;
        }

        /* Badges */
        .badge-activo {
            background: #3e4053;
            color: #fff;
            padding: 5px 10px;
            border-radius: 6px;
            font-family: monospace;
            letter-spacing: 1px;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div id="overlay" onclick="toggleMenu()"></div>
    <button id="btn-abrir"
        class="btn btn-primary d-md-none position-fixed top-0 start-0 m-3 z-3 shadow rounded-circle p-3"
        onclick="toggleMenu()"><i class="bi bi-list fs-4"></i></button>

    <div id="sidebar" class="d-flex flex-column">
        <div class="p-4 d-flex align-items-center border-bottom border-dark border-opacity-50">
            <div class="bg-primary rounded p-2 me-3"><i class="bi bi-cpu-fill text-white fs-4"></i></div>
            <div>
                <h5 class="fw-bold m-0 text-white">IT MASTER</h5><small class="text-muted">Pro Edition</small>
            </div>
        </div>
        <nav class="nav flex-column mt-4 flex-grow-1">
            <a class="nav-link active" onclick="verVentana('v-inicio', this)"><i class="bi bi-grid-1x2-fill me-3"></i>
                Dashboard</a>
            <a class="nav-link" onclick="verVentana('v-stock', this)"><i class="bi bi-box-seam-fill me-3"></i>
                Inventario</a>
            <a class="nav-link" onclick="verVentana('v-operaciones', this)"><i class="bi bi-people-fill me-3"></i>
                Asignaciones</a>
            <div class="mt-4 px-4 text-muted small text-uppercase fw-bold mb-2">Herramientas</div>
            <label class="nav-link text-info" style="cursor: pointer;"><i
                    class="bi bi-file-earmark-arrow-up-fill me-3"></i> Importar Excel<input type="file" id="inputExcel"
                    hidden accept=".xlsx, .xls" onchange="subirExcel(this)"></label>
            <a class="nav-link text-success" href="/exportar"><i class="bi bi-file-earmark-spreadsheet-fill me-3"></i>
                Exportar Todo</a>
        </nav>
        <div class="p-4"><button class="btn btn-outline-secondary w-100 rounded-pill" onclick="toggleDarkMode()"><i
                    class="bi bi-moon-stars-fill me-2"></i>Tema</button></div>
    </div>

    <div id="content">
        <div id="v-inicio" class="vista activa animate__animated animate__fadeIn">
            <h2 class="fw-bold mb-4">Resumen General</h2>
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card card-custom p-4 border-start border-5 border-primary h-100">
                        <div class="text-muted small fw-bold text-uppercase">Total Activos</div>
                        <div class="d-flex align-items-center justify-content-between mt-2">
                            <h2 class="fw-bold mb-0 count-up" id="total">0</h2>
                            <i class="bi bi-hdd-stack fs-1 text-primary opacity-25"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom p-4 border-start border-5 border-success h-100">
                        <div class="text-muted small fw-bold text-uppercase">Disponibles</div>
                        <div class="d-flex align-items-center justify-content-between mt-2">
                            <h2 class="fw-bold mb-0 text-success count-up" id="disp">0</h2>
                            <i class="bi bi-check-circle fs-1 text-success opacity-25"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom p-4 border-start border-5 border-danger h-100">
                        <div class="text-muted small fw-bold text-uppercase">Inversi√≥n</div>
                        <div class="d-flex align-items-center justify-content-between mt-2">
                            <h2 class="fw-bold mb-0 text-danger" id="valor-total">0‚Ç¨</h2>
                            <i class="bi bi-currency-euro fs-1 text-danger opacity-25"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom p-4 border-start border-5 border-warning h-100">
                        <div class="text-muted small fw-bold text-uppercase">Reparaci√≥n</div>
                        <div class="d-flex align-items-center justify-content-between mt-2">
                            <h2 class="fw-bold mb-0 text-warning count-up" id="rep">0</h2>
                            <i class="bi bi-tools fs-1 text-warning opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card card-custom p-4 mb-4">
                        <h5 class="fw-bold mb-4">Distribuci√≥n de Activos</h5>
                        <div class="row">
                            <div class="col-md-6"><canvas id="chartCategoria"></canvas></div>
                            <div class="col-md-6"><canvas id="chartDelegacion"></canvas></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card card-custom p-4 h-100">
                        <h5 class="fw-bold mb-4">Feed de Actividad</h5>
                        <div id="feed-actividad" style="max-height: 400px; overflow-y: auto;" class="pe-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="v-stock" class="vista animate__animated animate__fadeIn">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">Inventario</h2>
                <button class="btn btn-primary rounded-pill px-4" onclick="toggleForm()"><i
                        class="bi bi-plus-lg me-2"></i>Nuevo Activo</button>
            </div>

            <div id="form-alta" class="card card-custom p-4 mb-4" style="display:none;">
                <h6 class="text-primary fw-bold mb-3">Alta R√°pida</h6>
                <div class="row g-3">
                    <div class="col-md-2"><input type="text" id="n-activo" class="form-control"
                            placeholder="Etiqueta (IT-001)"></div>
                    <div class="col-md-2"><select id="cat" class="form-select">
                            <option value="Laptop">Laptop üíª</option>
                            <option value="Monitor">Monitor üñ•Ô∏è</option>
                            <option value="M√≥vil">M√≥vil üì±</option>
                        </select></div>
                    <div class="col-md-2"><input type="text" id="mod" class="form-control" placeholder="Modelo"></div>
                    <div class="col-md-2"><input type="text" id="ser" class="form-control" placeholder="Serie S/N">
                    </div>
                    <div class="col-md-2"><input type="number" id="coste" class="form-control" placeholder="Coste ‚Ç¨">
                    </div>
                    <div class="col-md-2"><button onclick="guardar()" class="btn btn-success w-100">Guardar</button>
                    </div>
                    <div class="col-md-3"><input type="date" id="fecha-compra" class="form-control"></div>
                    <div class="col-md-3"><input type="text" id="del" class="form-control" placeholder="Delegaci√≥n">
                    </div>
                </div>
            </div>

            <div class="table-responsive card-custom p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-body-tertiary border-bottom">
                        <tr>
                            <th class="p-3">ID</th>
                            <th>Modelo</th>
                            <th>Serie</th>
                            <th>Sede</th>
                            <th>Coste</th>
                            <th>Estado</th>
                            <th class="text-end p-3">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="lista-stock"></tbody>
                </table>
            </div>
        </div>

        <div id="v-operaciones" class="vista animate__animated animate__fadeIn">
            <h2 class="fw-bold mb-4">Asignaciones</h2>
            <div class="input-group mb-4 shadow-sm">
                <span class="input-group-text bg-white border-0 ps-3"><i class="bi bi-search"></i></span>
                <input type="text" id="buscador" class="form-control border-0 p-3"
                    placeholder="Buscar empleado, serie o modelo..." onkeyup="filtrar()">
            </div>
            <div class="table-responsive card-custom p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-body-tertiary">
                        <tr>
                            <th class="p-3">Activo</th>
                            <th>Detalle</th>
                            <th>Asignado a</th>
                            <th class="text-end p-3">Gesti√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="lista-asignar"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEditar" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold">Ficha de Activo</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-4">
                        <div class="col-md-8">
                            <input type="hidden" id="edit-id">
                            <div class="row g-3 mb-3">
                                <div class="col-6"><label class="small text-muted fw-bold">Etiqueta</label><input
                                        type="text" id="edit-n-activo" class="form-control bg-light border-0 fw-bold">
                                </div>
                                <div class="col-6"><label class="small text-muted fw-bold">Sede</label><input
                                        type="text" id="edit-del" class="form-control bg-light border-0"></div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-6"><label class="small text-muted fw-bold">Categor√≠a</label><select
                                        id="edit-cat" class="form-select bg-light border-0">
                                        <option value="Laptop">Laptop</option>
                                        <option value="Monitor">Monitor</option>
                                        <option value="M√≥vil">M√≥vil</option>
                                    </select></div>
                                <div class="col-6"><label class="small text-muted fw-bold">Modelo</label><input
                                        type="text" id="edit-mod" class="form-control bg-light border-0"></div>
                            </div>
                            <div class="mb-3"><label class="small text-muted fw-bold">N√∫mero de Serie</label><input
                                    type="text" id="edit-ser" class="form-control bg-light border-0 font-monospace">
                            </div>
                            <div class="row g-3 mb-4 p-3 bg-light rounded-3 mx-0">
                                <div class="col-6"><label class="small text-muted fw-bold">Coste (‚Ç¨)</label><input
                                        type="number" id="edit-coste" class="form-control border-0"></div>
                                <div class="col-6"><label class="small text-muted fw-bold">Fecha Compra</label><input
                                        type="date" id="edit-fecha" class="form-control border-0"></div>
                            </div>
                            <button class="btn btn-warning w-100 rounded-pill fw-bold" onclick="marcarReparacion()"><i
                                    class="bi bi-tools me-2"></i>Enviar a Reparaci√≥n</button>
                        </div>
                        <div class="col-md-4 border-start text-center">
                            <div id="qr-code" class="p-3 bg-white shadow-sm rounded mb-3 d-inline-block"></div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-dark btn-sm rounded-pill" onclick="imprimirQR()"><i
                                        class="bi bi-qr-code me-2"></i>Sticker</button>
                                <button class="btn btn-primary btn-sm rounded-pill" onclick="imprimirFichaTecnica()"><i
                                        class="bi bi-file-text me-2"></i>Ficha PDF</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light"><button onclick="confirmarEdicion()"
                        class="btn btn-success px-5 rounded-pill fw-bold shadow">Guardar Cambios</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAsignar" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Asignar Equipo</h5>
                </div>
                <div class="modal-body"><input type="hidden" id="id-asignar-temp"><input type="text"
                        id="nombre-usuario-modal" class="form-control p-3 bg-light border-0"
                        placeholder="Nombre del empleado"></div>
                <div class="modal-footer border-0"><button onclick="confirmarAsignacion()"
                        class="btn btn-primary w-100 rounded-pill">Confirmar</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalHistorial" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="tituloHistorial"></h5><button class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" id="cuerpoHistorial"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let globalData = [];
        let chart1 = null, chart2 = null;

        // UI Helpers
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
        function toggleForm() { const f = document.getElementById('form-alta'); f.style.display = f.style.display === 'none' ? 'block' : 'none'; }
        function toggleDarkMode() { document.documentElement.setAttribute('data-bs-theme', document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark'); }
        function verVentana(id, el) { document.querySelectorAll('.vista').forEach(v => v.classList.remove('activa')); document.getElementById(id).classList.add('activa'); document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); el.classList.add('active'); if (window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('active')) toggleMenu(); }

        // ANIMAR N√öMEROS (CountUp logic simple)
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        // CARGA DE DATOS
        async function cargar() {
            try {
                const res = await fetch('/activos');
                if (res.status === 401) { location.reload(); return; } // Auto login
                const data = await res.json();
                globalData = data; // Guardamos en memoria para editar sin errores

                // KPIs Animados
                animateValue(document.getElementById('total'), 0, data.length, 1000);
                animateValue(document.getElementById('disp'), 0, data.filter(x => x.estado === 'Disponible').length, 1000);
                animateValue(document.getElementById('rep'), 0, data.filter(x => x.estado === 'En Reparaci√≥n').length, 1000);

                const valor = data.reduce((a, b) => a + (b.coste || 0), 0);
                document.getElementById('valor-total').innerText = valor.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });

                // Render Tablas
                renderTablas(data);
                renderGraficos(data);
                cargarActividad();

                // QR Auto Check
                const params = new URLSearchParams(window.location.search);
                if (params.get('buscar')) {
                    const eq = data.find(d => d.serie === params.get('buscar'));
                    if (eq) { verVentana('v-stock', document.querySelectorAll('.nav-link')[1]); prepararEditar(eq.id); window.history.replaceState({}, '', location.pathname); }
                }

            } catch (e) { console.error(e); }
        }

        function renderTablas(data) {
            const tStock = document.getElementById('lista-stock'); tStock.innerHTML = '';
            const tAsignar = document.getElementById('lista-asignar'); tAsignar.innerHTML = '';
            let delay = 0;

            data.forEach(x => {
                const color = x.estado === 'Disponible' ? 'success' : (x.estado === 'Asignado' ? 'primary' : 'warning');
                const rowStyle = `animation-delay: ${delay}ms`; delay += 50;

                tStock.innerHTML += `<tr class="table-row-anim" style="${rowStyle}">
                    <td class="fw-bold text-muted">#${x.id}</td>
                    <td><div class="fw-bold">${x.modelo}</div><small class="badge-activo">${x.numero_activo || 'N/A'}</small></td>
                    <td><code class="text-primary">${x.serie}</code></td>
                    <td>${x.delegacion}</td>
                    <td>${(x.coste || 0).toFixed(2)}‚Ç¨</td>
                    <td><span class="status-dot bg-${color}"></span>${x.estado}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-light text-primary shadow-sm" onclick="prepararEditar(${x.id})"><i class="bi bi-pencil-fill"></i></button>
                        <button class="btn btn-sm btn-light text-danger shadow-sm ms-1" onclick="borrar(${x.id})"><i class="bi bi-trash-fill"></i></button>
                    </td>
                </tr>`;

                tAsignar.innerHTML += `<tr class="table-row-anim" style="${rowStyle}">
                    <td><div class="fw-bold">${x.modelo}</div><small class="text-muted">${x.numero_activo}</small></td>
                    <td><code>${x.serie}</code></td>
                    <td><span class="badge bg-secondary rounded-pill px-3">${x.usuario}</span></td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-primary rounded-pill px-3 shadow-sm" onclick="prepararAsignar(${x.id})">Asignar</button>
                        <button class="btn btn-sm btn-outline-secondary rounded-circle ms-1" onclick="historial(${x.id}, '${x.modelo}')"><i class="bi bi-clock-history"></i></button>
                    </td>
                </tr>`;
            });
        }

        // EDICI√ìN "INFALIBLE" (Busca por ID)
        function prepararEditar(id) {
            const item = globalData.find(x => x.id === id); // MAGIA AQU√ç
            if (!item) return;

            document.getElementById('edit-id').value = item.id;
            document.getElementById('edit-n-activo').value = item.numero_activo;
            document.getElementById('edit-cat').value = item.categoria;
            document.getElementById('edit-mod').value = item.modelo;
            document.getElementById('edit-ser').value = item.serie;
            document.getElementById('edit-del').value = item.delegacion;
            document.getElementById('edit-coste').value = item.coste;
            document.getElementById('edit-fecha').value = item.fecha_compra;

            const qr = document.getElementById("qr-code"); qr.innerHTML = "";
            new QRCode(qr, { text: `${window.location.origin}/?buscar=${item.serie}`, width: 120, height: 120 });

            new bootstrap.Modal(document.getElementById('modalEditar')).show();
        }

        async function confirmarEdicion() {
            const id = document.getElementById('edit-id').value;
            const body = {
                categoria: document.getElementById('edit-cat').value,
                modelo: document.getElementById('edit-mod').value,
                serie: document.getElementById('edit-ser').value,
                numero_activo: document.getElementById('edit-n-activo').value,
                delegacion: document.getElementById('edit-del').value,
                coste: parseFloat(document.getElementById('edit-coste').value) || 0,
                fecha_compra: document.getElementById('edit-fecha').value
            };

            const res = await fetch(`/actualizar/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
                Swal.fire({ icon: 'success', title: 'Actualizado', timer: 1500, showConfirmButton: false });
                cargar();
            } else Swal.fire('Error', 'No se pudo actualizar', 'error');
        }

        // GUARDAR NUEVO
        async function guardar() {
            const body = {
                categoria: document.getElementById('cat').value, modelo: document.getElementById('mod').value, serie: document.getElementById('ser').value,
                numero_activo: document.getElementById('n-activo').value, delegacion: document.getElementById('del').value || 'Central',
                coste: parseFloat(document.getElementById('coste').value) || 0, fecha_compra: document.getElementById('fecha-compra').value
            };
            if (!body.modelo || !body.serie) return Swal.fire('Ups', 'Faltan datos obligatorios', 'warning');

            const res = await fetch('/crear', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            const json = await res.json();
            if (json.status === 'success') {
                Swal.fire({ icon: 'success', title: 'Guardado', timer: 1500, showConfirmButton: false });
                toggleForm(); cargar();
            } else Swal.fire('Error', json.message, 'error');
        }

        // OTRAS FUNCIONES (ASIGNAR, REPARAR, BORRAR)
        function prepararAsignar(id) { document.getElementById('id-asignar-temp').value = id; new bootstrap.Modal(document.getElementById('modalAsignar')).show(); }
        async function confirmarAsignacion() {
            const id = document.getElementById('id-asignar-temp').value;
            const u = document.getElementById('nombre-usuario-modal').value;
            if (!u) return;
            const res = await fetch('/asignar', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, usuario: u }) });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('modalAsignar')).hide();
                const { isConfirmed } = await Swal.fire({ title: '¬°Asignado!', text: '¬øQuieres descargar el Acta de Entrega?', icon: 'success', showCancelButton: true, confirmButtonText: 'S√≠, descargar PDF' });
                if (isConfirmed) generarPDF(u);
                cargar();
            }
        }

        async function marcarReparacion() {
            const { value: text } = await Swal.fire({ input: 'textarea', inputLabel: 'Motivo de Aver√≠a', inputPlaceholder: 'Escribe aqu√≠...', showCancelButton: true });
            if (text) {
                const id = document.getElementById('edit-id').value;
                await fetch('/estado', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, estado: 'En Reparaci√≥n', nota: text }) });
                bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
                cargar();
            }
        }

        function borrar(id) {
            Swal.fire({ title: '¬øEst√°s seguro?', text: "El equipo se archivar√°", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠, archivar' }).then(async (result) => {
                if (result.isConfirmed) {
                    await fetch(`/eliminar/${id}`, { method: 'DELETE' });
                    Swal.fire('Archivado', 'El equipo ha sido ocultado.', 'success');
                    cargar();
                }
            })
        }

        // CHARTS & HELPERS
        function renderGraficos(data) {
            const ctx1 = document.getElementById('chartCategoria');
            const ctx2 = document.getElementById('chartDelegacion');

            const cats = {}, dels = {};
            data.forEach(x => { cats[x.categoria] = (cats[x.categoria] || 0) + 1; dels[x.delegacion] = (dels[x.delegacion] || 0) + 1; });

            if (chart1) chart1.destroy();
            chart1 = new Chart(ctx1, { type: 'bar', data: { labels: Object.keys(cats), datasets: [{ label: 'Stock', data: Object.values(cats), backgroundColor: '#0d6efd', borderRadius: 5 }] }, options: { scales: { y: { beginAtZero: true } } } });

            if (chart2) chart2.destroy();
            chart2 = new Chart(ctx2, { type: 'doughnut', data: { labels: Object.keys(dels), datasets: [{ data: Object.values(dels), backgroundColor: ['#6610f2', '#0dcaf0', '#20c997'] }] } });
        }

        function cargarActividad() {
            fetch('/actividad').then(r => r.json()).then(data => {
                const f = document.getElementById('feed-actividad'); f.innerHTML = '';
                data.forEach(x => f.innerHTML += `<div class="p-3 mb-2 bg-light rounded shadow-sm border-start border-4 border-primary"><small class="text-muted">${new Date(x.fecha).toLocaleString()}</small><div class="fw-bold">${x.modelo}</div><div>${x.detalle}</div></div>`);
            });
        }

        function generarPDF(u) {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.text("ACTA DE ENTREGA", 105, 20, null, null, "center");
            doc.text(`Responsable: ${u}`, 20, 40); doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 50);
            doc.line(20, 100, 80, 100); doc.text("Firma", 20, 105);
            doc.save(`Acta_${u}.pdf`);
        }

        function imprimirQR() {
            const c = document.getElementById('qr-code').innerHTML, s = document.getElementById('edit-ser').value;
            const w = window.open('', '', 'height=400,width=400'); w.document.write(`<html><body style="display:flex;justify-content:center;align-items:center;height:100vh">${c}<br>${s}</body></html>`);
            w.document.close(); setTimeout(() => w.print(), 500);
        }

        function imprimirFichaTecnica() {
            const id = document.getElementById('edit-id').value;
            fetch(`/historial/${id}`).then(r => r.json()).then(h => {
                const { jsPDF } = window.jspdf; const doc = new jsPDF();
                doc.text(`FICHA T√âCNICA - ${document.getElementById('edit-mod').value}`, 20, 20);
                doc.autoTable({ startY: 30, head: [['Fecha', 'Detalle']], body: h.map(x => [new Date(x.fecha).toLocaleString(), x.detalle]) });
                doc.save('ficha.pdf');
            });
        }

        function subirExcel(i) {
            let fd = new FormData(); fd.append("file", i.files[0]);
            fetch('/importar', { method: 'POST', body: fd }).then(r => r.json()).then(res => { Swal.fire('Importado', res.message, 'success'); cargar(); });
        }

        function filtrar() {
            const v = document.getElementById('buscador').value.toLowerCase();
            document.querySelectorAll('#lista-asignar tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none');
        }

        cargar();
    </script>
</body>

</html>