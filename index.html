<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Master Enterprise v2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --sidebar-width: 260px;
            --card-bg: #fff;
            --body-bg: #f4f6f9;
        }

        [data-bs-theme="dark"] {
            --card-bg: #212529;
            --body-bg: #121212;
        }

        body {
            background-color: var(--body-bg);
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow-x: hidden;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1900;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
            backdrop-filter: blur(3px);
        }

        #overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* SIDEBAR MEJORADA */
        @media (min-width: 769px) {
            #sidebar {
                width: var(--sidebar-width);
                height: 100vh;
                position: fixed;
                left: 0;
                background: #1a1d20;
                color: white;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
            }

            #content {
                margin-left: var(--sidebar-width);
                padding: 30px;
                width: calc(100% - var(--sidebar-width));
            }

            #btn-abrir {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -280px;
                width: var(--sidebar-width);
                height: 100vh;
                background: #1a1d20;
                z-index: 2000;
                transition: 0.3s;
                box-shadow: 4px 0 15px rgba(0, 0, 0, 0.5);
            }

            #sidebar.active {
                left: 0;
            }

            #content {
                margin-left: 0;
                padding: 15px;
                width: 100%;
            }
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.75);
            padding: 14px 24px;
            transition: 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
            border-radius: 0 25px 25px 0;
            margin-right: 15px;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .nav-link.active {
            background: rgba(13, 110, 253, 0.15);
            color: #4dabf7;
            border-left: 4px solid #0d6efd;
            font-weight: 600;
        }

        .card-custom {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            background-color: var(--card-bg);
            margin-bottom: 20px;
        }

        /* FEED DE ACTIVIDAD */
        .activity-item {
            border-left: 2px solid #495057;
            padding-left: 15px;
            padding-bottom: 20px;
            position: relative;
        }

        .activity-item::before {
            content: "";
            width: 8px;
            height: 8px;
            background: #0d6efd;
            border-radius: 50%;
            position: absolute;
            left: -5px;
            top: 6px;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2);
        }

        .badge-delegacion {
            background-color: #6610f2;
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8em;
        }

        .badge-activo {
            background-color: #fd7e14;
            color: black;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
        }

        .vista {
            display: none;
            animation: fadeIn 0.3s;
        }

        .vista.activa {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div id="overlay" onclick="toggleMenu()"></div>
    <button id="btn-abrir" class="btn btn-dark d-md-none position-fixed top-0 start-0 m-3 z-3 shadow"
        onclick="toggleMenu()"><i class="bi bi-list fs-4"></i></button>

    <div id="sidebar">
        <div class="p-4 d-flex align-items-center mb-2">
            <i class="bi bi-shield-lock-fill fs-3 text-primary me-2"></i>
            <h4 class="fw-bold m-0 tracking-tight">IT MASTER</h4>
        </div>
        <nav class="nav flex-column">
            <a class="nav-link active" onclick="verVentana('v-inicio', this)"><i class="bi bi-speedometer2 me-3"></i>
                Dashboard</a>
            <a class="nav-link" onclick="verVentana('v-stock', this)"><i class="bi bi-pc-display-horizontal me-3"></i>
                Inventario</a>
            <a class="nav-link" onclick="verVentana('v-operaciones', this)"><i class="bi bi-people me-3"></i>
                Asignaciones</a>
            <hr class="mx-3 opacity-25">
            <label class="nav-link text-info" style="cursor: pointer;"><i class="bi bi-cloud-arrow-up me-3"></i>
                Importar Excel<input type="file" id="inputExcel" hidden accept=".xlsx, .xls"
                    onchange="subirExcel(this)"></label>
            <a class="nav-link text-success" href="/exportar"><i class="bi bi-file-earmark-spreadsheet me-3"></i>
                Exportar Todo</a>
        </nav>
        <div class="p-4 mt-auto">
            <button class="btn btn-outline-secondary w-100 btn-sm" onclick="toggleDarkMode()"><i
                    class="bi bi-moon-stars me-2"></i>Cambiar Tema</button>
        </div>
    </div>

    <div id="content">
        <div id="stock-alerts"></div>

        <div id="v-inicio" class="vista activa">
            <h3 class="mb-4 fw-bold">Visi√≥n General</h3>
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card card-custom p-4 border-start border-4 border-primary">
                        <h6>Total Activos</h6>
                        <h2 class="fw-bold" id="total">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom p-4 border-start border-4 border-success">
                        <h6>Disponibles</h6>
                        <h2 class="fw-bold text-success" id="disp">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom p-4 border-start border-4 border-info">
                        <h6>Asignados</h6>
                        <h2 class="fw-bold text-info" id="uso">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom p-4 border-start border-4 border-warning">
                        <h6>Delegaciones</h6>
                        <h2 class="fw-bold text-warning" id="num-del">0</h2>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card card-custom p-4">
                                <h6 class="text-muted mb-3">Por Delegaci√≥n</h6><canvas id="chartDelegacion"
                                    style="max-height: 200px;"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card card-custom p-4">
                                <h6 class="text-muted mb-3">Por Categor√≠a</h6><canvas id="chartCategoria"
                                    style="max-height: 200px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card card-custom p-4 h-100">
                        <h6 class="fw-bold mb-4"><i class="bi bi-activity me-2"></i>Actividad Reciente</h6>
                        <div id="feed-actividad" style="max-height: 400px; overflow-y: auto;">Cargando...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="v-stock" class="vista">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">Inventario</h3>
            </div>

            <div class="card card-custom p-4 mb-4">
                <h6 class="mb-3 fw-bold text-primary">Registrar Nuevo Activo</h6>
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="small text-muted">N¬∫ Activo (Etiqueta)</label>
                        <input type="text" id="n-activo" class="form-control bg-body-secondary border-0"
                            placeholder="Ej: IT-001">
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted">Categor√≠a</label>
                        <select id="cat" class="form-select bg-body-secondary border-0">
                            <option value="Laptop">Laptop üíª</option>
                            <option value="Monitor">Monitor üñ•Ô∏è</option>
                            <option value="M√≥vil">M√≥vil üì±</option>
                            <option value="Perif√©rico">Perif√©rico üñ±Ô∏è</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted">Delegaci√≥n</label>
                        <input type="text" id="del" class="form-control bg-body-secondary border-0"
                            placeholder="Ej: Madrid" list="list-delegaciones">
                        <datalist id="list-delegaciones">
                            <option value="Central">
                            <option value="Madrid">
                            <option value="Barcelona">
                            <option value="Valencia">
                        </datalist>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted">Modelo</label>
                        <input type="text" id="mod" class="form-control bg-body-secondary border-0"
                            placeholder="Modelo">
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted">S/N (Serie)</label>
                        <input type="text" id="ser" class="form-control bg-body-secondary border-0"
                            placeholder="S/N Fabricante">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button id="btn-guardar" onclick="guardar()" class="btn btn-primary w-100 fw-bold"><i
                                class="bi bi-plus-lg me-1"></i> A√±adir</button>
                    </div>
                </div>
            </div>

            <div class="table-responsive card-custom p-0 shadow-sm">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-body-tertiary">
                        <tr>
                            <th class="p-3">N¬∫ Activo</th>
                            <th>Delegaci√≥n</th>
                            <th>Tipo / Modelo</th>
                            <th>S/N</th>
                            <th>Estado</th>
                            <th class="text-end p-3">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="lista-stock"></tbody>
                </table>
            </div>
        </div>

        <div id="v-operaciones" class="vista">
            <h3 class="mb-4 fw-bold">Asignaciones</h3>
            <div class="mb-4 position-relative">
                <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                <input type="text" id="buscador" class="form-control p-3 ps-5 border-0 shadow-sm rounded-pill"
                    placeholder="Buscar por usuario, equipo, serie o etiqueta..." onkeyup="filtrar()">
            </div>
            <div class="table-responsive card-custom p-0 shadow-sm">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-body-tertiary">
                        <tr>
                            <th class="p-3">Equipo</th>
                            <th>Identificador</th>
                            <th>Usuario</th>
                            <th class="text-end p-3">Gesti√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="lista-asignar"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEditar" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Ficha de Activo</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-4">
                    <div class="row g-4">
                        <div class="col-md-7">
                            <input type="hidden" id="edit-id">
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="small fw-bold text-muted">N¬∫ Activo</label>
                                    <input type="text" id="edit-n-activo"
                                        class="form-control bg-body-secondary border-0 fw-bold">
                                </div>
                                <div class="col-6">
                                    <label class="small fw-bold text-muted">Delegaci√≥n</label>
                                    <input type="text" id="edit-del" class="form-control bg-body-secondary border-0">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-bold text-muted">Categor√≠a</label>
                                <select id="edit-cat" class="form-select bg-body-secondary border-0">
                                    <option value="Laptop">Laptop</option>
                                    <option value="Monitor">Monitor</option>
                                    <option value="M√≥vil">M√≥vil</option>
                                    <option value="Perif√©rico">Perif√©rico</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-bold text-muted">Modelo</label>
                                <input type="text" id="edit-mod" class="form-control bg-body-secondary border-0">
                            </div>
                            <div class="mb-3">
                                <label class="small fw-bold text-muted">S/N Fabricante</label>
                                <input type="text" id="edit-ser"
                                    class="form-control bg-body-secondary border-0 text-monospace">
                            </div>
                        </div>
                        <div
                            class="col-md-5 text-center d-flex flex-column align-items-center justify-content-center border-start">
                            <div id="qr-code" class="p-2 bg-white border rounded mb-3"></div>
                            <div class="d-grid gap-2 w-75">
                                <button class="btn btn-sm btn-outline-dark" onclick="imprimirQR()"><i
                                        class="bi bi-qr-code me-2"></i>Imprimir Etiqueta</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="imprimirFichaTecnica()"><i
                                        class="bi bi-file-text me-2"></i>Ficha PDF</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button id="btn-confirmar-edit" onclick="confirmarEdicion()"
                        class="btn btn-warning w-100 fw-bold py-2">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAsignar" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Asignar Equipo</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"><input type="hidden" id="id-asignar-temp"><label
                        class="small text-muted mb-1">Usuario Responsable</label><input type="text"
                        id="nombre-usuario-modal" class="form-control bg-body-secondary border-0 p-3"
                        placeholder="Nombre y Apellidos"></div>
                <div class="modal-footer border-0"><button onclick="confirmarAsignacion()"
                        class="btn btn-primary w-100 fw-bold">Confirmar Asignaci√≥n</button></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalBorrar" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4 text-center p-4"><input type="hidden"
                    id="id-borrar-temp"><i class="bi bi-archive text-warning display-4 mb-3"></i>
                <h5 class="fw-bold">¬øArchivar Activo?</h5>
                <p class="small text-muted">Se ocultar√° de la lista pero conservar√° su historial.</p><button
                    onclick="confirmarBorrado()" class="btn btn-warning w-100">S√≠, Archivar</button>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalHistorial" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 bg-body-tertiary">
                    <h5 class="modal-title fw-bold" id="tituloHistorial"></h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" id="cuerpoHistorial" style="max-height:400px;overflow-y:auto;"></div>
            </div>
        </div>
    </div>
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-white border-0 rounded-3 shadow" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toast-mensaje"></div><button type="button"
                    class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const iconos = { Laptop: 'üíª', Monitor: 'üñ•Ô∏è', M√≥vil: 'üì±', Perif√©rico: 'üñ±Ô∏è' };
        let chartDelegacionInstance = null, chartCatInstance = null;
        let globalData = [];

        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
        function toggleDarkMode() { document.documentElement.setAttribute('data-bs-theme', document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark'); }
        function verVentana(id, el) { document.querySelectorAll('.vista').forEach(v => v.classList.remove('activa')); document.getElementById(id).classList.add('activa'); document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); el.classList.add('active'); if (window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('active')) toggleMenu(); }
        function notificar(msg, color = 'bg-dark') { const t = document.getElementById('liveToast'); document.getElementById('toast-mensaje').innerText = msg; t.className = `toast align-items-center text-white border-0 rounded-3 shadow ${color}`; new bootstrap.Toast(t).show(); }

        // --- L√ìGICA DE DATOS ---
        function cargar() {
            fetch('/activos').then(r => r.json()).then(data => {
                globalData = data;

                // KPIs
                document.getElementById('total').innerText = data.length;
                document.getElementById('disp').innerText = data.filter(x => x.estado === 'Disponible').length;
                document.getElementById('uso').innerText = data.filter(x => x.estado === 'Asignado').length;

                // ALERTA STOCK
                const conteo = {}; const delegaciones = {};
                data.forEach(x => {
                    if (x.estado === 'Disponible') conteo[x.categoria] = (conteo[x.categoria] || 0) + 1;
                    delegaciones[x.delegacion] = (delegaciones[x.delegacion] || 0) + 1;
                });

                document.getElementById('num-del').innerText = Object.keys(delegaciones).length;

                const alertas = document.getElementById('stock-alerts'); alertas.innerHTML = '';
                for (const [c, n] of Object.entries(conteo)) if (n < 2) alertas.innerHTML += `<div class="alert alert-warning m-4 shadow-sm border-0"><i class="bi bi-exclamation-triangle me-2"></i>Stock bajo de <strong>${c}</strong> (${n})</div>`;

                // GR√ÅFICOS
                const cats = {}; data.forEach(x => cats[x.categoria] = (cats[x.categoria] || 0) + 1);

                if (chartDelegacionInstance) chartDelegacionInstance.destroy();
                chartDelegacionInstance = new Chart(document.getElementById('chartDelegacion'), { type: 'doughnut', data: { labels: Object.keys(delegaciones), datasets: [{ data: Object.values(delegaciones), backgroundColor: ['#6610f2', '#0d6efd', '#0dcaf0', '#20c997'] }] } });

                if (chartCatInstance) chartCatInstance.destroy();
                chartCatInstance = new Chart(document.getElementById('chartCategoria'), { type: 'bar', data: { labels: Object.keys(cats), datasets: [{ label: 'Total', data: Object.values(cats), backgroundColor: '#adb5bd', borderRadius: 6 }] }, options: { scales: { y: { beginAtZero: true } } } });

                // TABLAS
                const tStock = document.getElementById('lista-stock'); tStock.innerHTML = '';
                const tAsignar = document.getElementById('lista-asignar'); tAsignar.innerHTML = '';

                data.forEach(a => {
                    const etiqueta = a.numero_activo ? `<span class="badge-activo">${a.numero_activo}</span>` : '<span class="text-muted small">Sin etiqueta</span>';
                    const delBadge = `<span class="badge-delegacion">${a.delegacion}</span>`;

                    tStock.innerHTML += `<tr>
                        <td class="p-3">${etiqueta}</td>
                        <td>${delBadge}</td>
                        <td>${iconos[a.categoria] || ''} ${a.modelo}</td>
                        <td><code>${a.serie}</code></td>
                        <td><span class="badge ${a.estado === 'Disponible' ? 'bg-success' : 'bg-info'} bg-opacity-75">${a.estado}</span></td>
                        <td class="text-end p-3">
                            <button class="btn btn-sm btn-light border" onclick="prepararEditar(${a.id}, '${a.categoria}', '${a.modelo}', '${a.serie}', '${a.numero_activo}', '${a.delegacion}')"><i class="bi bi-pencil-fill text-warning"></i></button>
                            <button class="btn btn-sm btn-light border ms-1" onclick="prepararBorrar(${a.id})"><i class="bi bi-archive-fill text-danger"></i></button>
                        </td>
                    </tr>`;

                    tAsignar.innerHTML += `<tr>
                        <td class="p-3 fw-bold">${a.modelo}</td>
                        <td><div class="small">${etiqueta}</div><div class="small text-muted">${a.serie}</div></td>
                        <td><span class="badge bg-secondary text-white">${a.usuario}</span></td>
                        <td class="text-end p-3">
                            <button class="btn btn-sm btn-primary rounded-pill px-3 me-1" onclick="prepararAsignar(${a.id}, '${a.modelo}', '${a.serie}')">Asignar</button>
                            <button class="btn btn-sm btn-outline-secondary rounded-circle" onclick="verHistorial(${a.id}, '${a.modelo}')"><i class="bi bi-clock-history"></i></button>
                        </td>
                    </tr>`;
                });

                // Feed Actividad
                fetch('/actividad').then(r => r.json()).then(act => {
                    const feed = document.getElementById('feed-actividad'); feed.innerHTML = '';
                    act.forEach(x => feed.innerHTML += `<div class="activity-item"><small class="text-muted d-block mb-1">${new Date(x.fecha).toLocaleString()}</small><span class="badge-activo me-2">${x.numero_activo || 'S/N'}</span><span class="fw-bold">${x.modelo}</span>: ${x.detalle}</div>`);
                });

            }).catch(e => { if (e.toString().includes("401")) location.reload(); });
        }

        // --- ACCIONES CRUD ---
        function guardar() {
            const d = {
                categoria: document.getElementById('cat').value, modelo: document.getElementById('mod').value,
                serie: document.getElementById('ser').value, numero_activo: document.getElementById('n-activo').value,
                delegacion: document.getElementById('del').value || 'Central'
            };
            if (!d.modelo || !d.serie) return notificar("Faltan datos obligatorios", "bg-warning");
            fetch('/crear', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) })
                .then(r => r.json()).then(res => {
                    if (res.status === 'success') { notificar("‚úÖ Activo Creado", "bg-success"); cargar(); document.getElementById('mod').value = ''; document.getElementById('ser').value = ''; }
                    else notificar(res.message, "bg-danger");
                });
        }

        function prepararEditar(id, cat, mod, ser, nAct, del) {
            document.getElementById('edit-id').value = id; document.getElementById('edit-cat').value = cat;
            document.getElementById('edit-mod').value = mod; document.getElementById('edit-ser').value = ser;
            document.getElementById('edit-n-activo').value = nAct || ''; document.getElementById('edit-del').value = del || 'Central';

            // QR apunta a buscar por SERIE o ETIQUETA
            const valorQR = nAct || ser;
            const qrC = document.getElementById("qr-code"); qrC.innerHTML = "";
            new QRCode(qrC, { text: `${window.location.origin}/?buscar=${valorQR}`, width: 110, height: 110 });

            new bootstrap.Modal(document.getElementById('modalEditar')).show();
        }

        function confirmarEdicion() {
            const id = document.getElementById('edit-id').value;
            const d = {
                categoria: document.getElementById('edit-cat').value, modelo: document.getElementById('edit-mod').value,
                serie: document.getElementById('edit-ser').value, numero_activo: document.getElementById('edit-n-activo').value,
                delegacion: document.getElementById('edit-del').value
            };
            fetch(`/actualizar/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) })
                .then(r => r.json()).then(res => {
                    if (res.status === 'success') { bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide(); notificar("Datos actualizados", "bg-success"); cargar(); }
                    else notificar(res.message, "bg-danger");
                });
        }

        // IMPRESI√ìN ETIQUETA MEJORADA
        function imprimirQR() {
            const qr = document.getElementById('qr-code').innerHTML;
            const nAct = document.getElementById('edit-n-activo').value || 'SIN ETIQUETA';
            const mod = document.getElementById('edit-mod').value;
            const sn = document.getElementById('edit-ser').value;

            const w = window.open('', '', 'height=400,width=400');
            w.document.write(`<html><body style="font-family:sans-serif;text-align:center;display:flex;align-items:center;justify-content:center;height:100vh;margin:0">
                <div style="border:2px solid black;padding:10px;width:250px;border-radius:8px">
                    <h4 style="margin:0;background:black;color:white;padding:5px">PROPIEDAD IT MASTER</h4>
                    <div style="display:flex;justify-content:center;margin:10px 0">${qr}</div>
                    <div style="font-size:18px;font-weight:bold;border:1px solid #ccc;padding:5px;margin-bottom:5px">${nAct}</div>
                    <div style="font-size:10px">Modelo: ${mod} | S/N: ${sn}</div>
                </div>
            </body></html>`);
            w.document.close(); setTimeout(() => { w.print(); w.close() }, 500);
        }

        // FUNCIONES DE SOPORTE (Asignar, Borrar, Historial, Excel...)
        function prepararAsignar(id, mod, ser) { window.tempModelo = mod; window.tempSerie = ser; document.getElementById('id-asignar-temp').value = id; new bootstrap.Modal(document.getElementById('modalAsignar')).show(); }
        async function confirmarAsignacion() { const id = document.getElementById('id-asignar-temp').value, u = document.getElementById('nombre-usuario-modal').value; if (!u) return notificar("Falta usuario", "bg-warning"); const res = await fetch('/asignar', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, usuario: u }) }); if (res.ok) { bootstrap.Modal.getInstance(document.getElementById('modalAsignar')).hide(); notificar("Asignado", "bg-primary"); cargar(); } }
        function prepararBorrar(id) { document.getElementById('id-borrar-temp').value = id; new bootstrap.Modal(document.getElementById('modalBorrar')).show(); }
        function confirmarBorrado() { const id = document.getElementById('id-borrar-temp').value; fetch(`/eliminar/${id}`, { method: 'DELETE' }).then(() => { bootstrap.Modal.getInstance(document.getElementById('modalBorrar')).hide(); notificar("Archivado", "bg-warning"); cargar(); }) }
        function verHistorial(id, mod) { fetch(`/historial/${id}`).then(r => r.json()).then(d => { document.getElementById('tituloHistorial').innerText = `Historial: ${mod}`; let h = '<ul class="list-group list-group-flush">'; d.forEach(x => h += `<li class="list-group-item bg-transparent"><small class="text-muted">${new Date(x.fecha).toLocaleString()}</small><br><strong>${x.detalle}</strong></li>`); document.getElementById('cuerpoHistorial').innerHTML = h + '</ul>'; new bootstrap.Modal(document.getElementById('modalHistorial')).show(); }) }
        function subirExcel(i) { if (!i.files[0]) return; let f = new FormData(); f.append("file", i.files[0]); notificar("Subiendo...", "bg-info"); fetch('/importar', { method: 'POST', body: f }).then(r => r.json()).then(d => { notificar(d.message, d.status === 'success' ? 'bg-success' : 'bg-danger'); cargar(); i.value = '' }) }
        function filtrar() { const v = document.getElementById('buscador').value.toLowerCase(); document.querySelectorAll('#lista-asignar tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none') }

        cargar();
    </script>
</body>

</html>