<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Master V5 - Compact</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* AJUSTES DE TAMA√ëO PARA QUE NO SE VEA GIGANTE */
        :root {
            --sidebar-width: 240px;
            --card-bg: #fff;
            --body-bg: #f2f4f8;
            font-size: 14px;
        }

        /* Fuente base m√°s chica */
        [data-bs-theme="dark"] {
            --card-bg: #1e1e2d;
            --body-bg: #151521;
        }

        body {
            background-color: var(--body-bg);
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow-x: hidden;
        }

        /* Sidebar m√°s compacta */
        #sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: #1a1a27;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 1000;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            width: calc(100% - var(--sidebar-width));
            transition: 0.3s;
        }

        /* Mobile Overlay */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 900;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
            backdrop-filter: blur(4px);
        }

        #overlay.active {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 768px) {
            #sidebar {
                left: -280px;
            }

            #sidebar.active {
                left: 0;
            }

            #content {
                margin-left: 0;
                padding: 15px;
                width: 100%;
            }
        }

        .nav-link {
            color: #a2a3b7;
            padding: 10px 15px;
            margin: 4px 10px;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .nav-link.active {
            background: #0d6efd;
            color: white;
            box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
        }

        .card-custom {
            border: none;
            border-radius: 10px;
            background-color: var(--card-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }

        /* TABLA COMPACTA (Soluci√≥n al problema de tama√±o) */
        .table-compact td,
        .table-compact th {
            padding: 0.5rem 0.5rem;
            font-size: 0.85rem;
            vertical-align: middle;
            white-space: nowrap;
            /* Evita que el texto salte de l√≠nea haciendo la fila gorda */
        }

        .badge-activo {
            background: #3e4053;
            color: #fff;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
        }

        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .vista {
            display: none;
        }

        /* Importante para ocultar */
        .vista.activa {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div id="overlay" onclick="toggleMenu()"></div>
    <button id="btn-abrir"
        class="btn btn-primary d-md-none position-fixed top-0 start-0 m-3 z-3 shadow rounded-circle p-2"
        onclick="toggleMenu()"><i class="bi bi-list fs-5"></i></button>

    <div id="sidebar" class="d-flex flex-column">
        <div class="p-3 d-flex align-items-center border-bottom border-dark border-opacity-50">
            <div class="bg-primary rounded p-1 me-2"><i class="bi bi-cpu-fill text-white fs-5"></i></div>
            <div>
                <h6 class="fw-bold m-0 text-white">IT MASTER</h6><small class="text-muted"
                    style="font-size: 0.75rem;">Enterprise V5</small>
            </div>
        </div>
        <nav class="nav flex-column mt-3 flex-grow-1">
            <a class="nav-link active" onclick="verVentana('v-inicio', this)"><i class="bi bi-speedometer2 me-2"></i>
                Dashboard</a>
            <a class="nav-link" onclick="verVentana('v-stock', this)"><i class="bi bi-box-seam me-2"></i> Inventario</a>
            <a class="nav-link" onclick="verVentana('v-operaciones', this)"><i class="bi bi-people me-2"></i>
                Asignaciones</a>
            <div class="mt-4 px-3 text-muted" style="font-size: 0.7rem; font-weight: bold; text-transform: uppercase;">
                Herramientas</div>
            <label class="nav-link text-info" style="cursor: pointer;"><i class="bi bi-upload me-2"></i> Importar
                Excel<input type="file" id="inputExcel" hidden accept=".xlsx, .xls" onchange="subirExcel(this)"></label>
            <a class="nav-link text-success" href="/exportar"><i class="bi bi-download me-2"></i> Exportar</a>
        </nav>
        <div class="p-3"><button class="btn btn-outline-secondary w-100 btn-sm rounded-pill"
                onclick="toggleDarkMode()"><i class="bi bi-moon-stars me-2"></i>Tema</button></div>
    </div>

    <div id="content">

        <div id="v-inicio" class="vista activa">
            <h4 class="fw-bold mb-3">Resumen</h4>
            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <div class="card card-custom p-3 border-start border-4 border-primary h-100">
                        <small class="text-muted fw-bold">TOTAL ACTIVOS</small>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <h3 class="fw-bold mb-0" id="total">0</h3><i
                                class="bi bi-server fs-2 text-primary opacity-25"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom p-3 border-start border-4 border-success h-100">
                        <small class="text-muted fw-bold">DISPONIBLES</small>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <h3 class="fw-bold mb-0 text-success" id="disp">0</h3><i
                                class="bi bi-check-lg fs-2 text-success opacity-25"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom p-3 border-start border-4 border-danger h-100">
                        <small class="text-muted fw-bold">VALOR (EUR)</small>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <h3 class="fw-bold mb-0 text-danger" id="valor-total">0‚Ç¨</h3><i
                                class="bi bi-currency-euro fs-2 text-danger opacity-25"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom p-3 border-start border-4 border-warning h-100">
                        <small class="text-muted fw-bold">EN REPARACI√ìN</small>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <h3 class="fw-bold mb-0 text-warning" id="rep">0</h3><i
                                class="bi bi-tools fs-2 text-warning opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-lg-8">
                    <div class="card card-custom p-3 mb-3">
                        <h6 class="fw-bold mb-3">An√°lisis de Inventario</h6>
                        <div class="row">
                            <div class="col-md-6" style="height: 200px;"><canvas id="chartCategoria"></canvas></div>
                            <div class="col-md-6" style="height: 200px;"><canvas id="chartDelegacion"></canvas></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card card-custom p-3 h-100">
                        <h6 class="fw-bold mb-3">√öltima Actividad</h6>
                        <div id="feed-actividad" style="max-height: 250px; overflow-y: auto; font-size: 0.85rem;"
                            class="pe-1"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="v-stock" class="vista">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold m-0">Inventario</h4>
                <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="toggleForm()"><i
                        class="bi bi-plus-lg me-1"></i>Nuevo</button>
            </div>

            <div id="form-alta" class="card card-custom p-3 mb-3" style="display:none;">
                <div class="row g-2">
                    <div class="col-md-2"><input type="text" id="n-activo" class="form-control form-control-sm"
                            placeholder="Etiqueta (IT-001)"></div>
                    <div class="col-md-2"><select id="cat" class="form-select form-select-sm">
                            <option value="Laptop">Laptop üíª</option>
                            <option value="Monitor">Monitor üñ•Ô∏è</option>
                            <option value="M√≥vil">M√≥vil üì±</option>
                            <option value="Perif√©rico">Perif√©rico üñ±Ô∏è</option>
                        </select></div>
                    <div class="col-md-2"><input type="text" id="mod" class="form-control form-control-sm"
                            placeholder="Modelo"></div>
                    <div class="col-md-2"><input type="text" id="ser" class="form-control form-control-sm"
                            placeholder="Serie S/N"></div>
                    <div class="col-md-1"><input type="number" id="coste" class="form-control form-control-sm"
                            placeholder="‚Ç¨"></div>
                    <div class="col-md-2"><input type="text" id="del" class="form-control form-control-sm"
                            placeholder="Sede"></div>
                    <div class="col-md-1"><button onclick="guardar()" class="btn btn-success btn-sm w-100">OK</button>
                    </div>
                    <input type="hidden" id="fecha-compra">
                </div>
            </div>

            <div class="table-responsive card-custom p-0">
                <table class="table table-hover table-compact mb-0">
                    <thead class="bg-body-tertiary">
                        <tr>
                            <th class="ps-3">ID</th>
                            <th>Modelo</th>
                            <th>Serie</th>
                            <th>Sede</th>
                            <th>Coste</th>
                            <th>Estado</th>
                            <th class="text-end pe-3">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="lista-stock"></tbody>
                </table>
            </div>
        </div>
        <div id="v-operaciones" class="vista">
            <h4 class="fw-bold mb-3">Asignaciones</h4>
            <input type="text" id="buscador" class="form-control mb-3 shadow-sm border-0"
                placeholder="üîç Buscar por nombre, serie o modelo..." onkeyup="filtrar()">
            <div class="table-responsive card-custom p-0">
                <table class="table table-hover table-compact mb-0">
                    <thead class="bg-body-tertiary">
                        <tr>
                            <th class="ps-3">Equipo</th>
                            <th>Detalle</th>
                            <th>Usuario Actual</th>
                            <th class="text-end pe-3">Gesti√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="lista-asignar"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEditar" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header bg-primary text-white py-2">
                    <h6 class="modal-title fw-bold">Editar Activo</h6><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3">
                    <input type="hidden" id="edit-id">
                    <div class="row g-2 mb-2">
                        <div class="col-4"><label class="small fw-bold">Etiqueta</label><input type="text"
                                id="edit-n-activo" class="form-control form-control-sm bg-light"></div>
                        <div class="col-4"><label class="small fw-bold">Sede</label><input type="text" id="edit-del"
                                class="form-control form-control-sm bg-light"></div>
                        <div class="col-4"><label class="small fw-bold">Categor√≠a</label><select id="edit-cat"
                                class="form-select form-select-sm bg-light">
                                <option value="Laptop">Laptop</option>
                                <option value="Monitor">Monitor</option>
                                <option value="M√≥vil">M√≥vil</option>
                            </select></div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6"><label class="small fw-bold">Modelo</label><input type="text" id="edit-mod"
                                class="form-control form-control-sm bg-light"></div>
                        <div class="col-6"><label class="small fw-bold">Serie</label><input type="text" id="edit-ser"
                                class="form-control form-control-sm bg-light font-monospace"></div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-4"><label class="small fw-bold">Coste ‚Ç¨</label><input type="number"
                                id="edit-coste" class="form-control form-control-sm"></div>
                        <div class="col-8"><label class="small fw-bold">Fecha Compra</label><input type="date"
                                id="edit-fecha" class="form-control form-control-sm"></div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
                        <div id="qr-code"></div>
                        <div class="d-flex flex-column gap-1">
                            <button class="btn btn-outline-dark btn-sm" onclick="imprimirQR()">üñ®Ô∏è Sticker</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="imprimirFichaTecnica()">üìÑ
                                Ficha</button>
                            <button class="btn btn-outline-warning btn-sm" onclick="marcarReparacion()">üîß
                                Reparar</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-1 border-0"><button onclick="confirmarEdicion()"
                        class="btn btn-success btn-sm w-100">Guardar</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAsignar" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow">
                <div class="modal-header py-2 border-0">
                    <h6 class="fw-bold">Asignar a...</h6>
                </div>
                <div class="modal-body"><input type="hidden" id="id-asignar-temp"><input type="text"
                        id="nombre-usuario-modal" class="form-control" placeholder="Nombre empleado"></div>
                <div class="modal-footer border-0 py-1"><button onclick="confirmarAsignacion()"
                        class="btn btn-primary btn-sm w-100">Confirmar</button></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalHistorial" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header py-2 bg-light">
                    <h6 class="fw-bold m-0" id="tituloHistorial"></h6><button class="btn-close btn-sm"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" id="cuerpoHistorial"
                    style="max-height: 300px; overflow-y: auto; font-size: 0.85rem;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let globalData = [];
        let chart1 = null, chart2 = null;

        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
        function toggleForm() { const f = document.getElementById('form-alta'); f.style.display = f.style.display === 'none' ? 'block' : 'none'; }
        function toggleDarkMode() { document.documentElement.setAttribute('data-bs-theme', document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark'); }
        function verVentana(id, el) { document.querySelectorAll('.vista').forEach(v => v.classList.remove('activa')); document.getElementById(id).classList.add('activa'); document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); el.classList.add('active'); if (window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('active')) toggleMenu(); }

        // ANIMAR N√öMEROS
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        async function cargar() {
            try {
                const res = await fetch('/activos');
                if (res.status === 401) { location.reload(); return; }
                const data = await res.json();
                globalData = data;

                animateValue(document.getElementById('total'), 0, data.length, 800);
                animateValue(document.getElementById('disp'), 0, data.filter(x => x.estado === 'Disponible').length, 800);
                animateValue(document.getElementById('rep'), 0, data.filter(x => x.estado === 'En Reparaci√≥n').length, 800);

                const valor = data.reduce((a, b) => a + (b.coste || 0), 0);
                document.getElementById('valor-total').innerText = valor.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });

                renderTablas(data);
                renderGraficos(data);
                cargarActividad();

                const params = new URLSearchParams(window.location.search);
                if (params.get('buscar')) {
                    const eq = data.find(d => d.serie === params.get('buscar'));
                    if (eq) { verVentana('v-stock', document.querySelectorAll('.nav-link')[1]); prepararEditar(eq.id); window.history.replaceState({}, '', location.pathname); }
                }

            } catch (e) { console.error(e); }
        }

        function renderTablas(data) {
            const tStock = document.getElementById('lista-stock'); tStock.innerHTML = '';
            const tAsignar = document.getElementById('lista-asignar'); tAsignar.innerHTML = '';

            data.forEach(x => {
                const color = x.estado === 'Disponible' ? 'success' : (x.estado === 'Asignado' ? 'primary' : 'warning');

                tStock.innerHTML += `<tr>
                    <td class="ps-3 text-muted">#${x.id}</td>
                    <td><div class="fw-bold text-truncate" style="max-width:150px">${x.modelo}</div><small class="badge-activo">${x.numero_activo || 'N/A'}</small></td>
                    <td><code class="text-primary small">${x.serie}</code></td>
                    <td>${x.delegacion}</td>
                    <td>${(x.coste || 0).toFixed(0)}‚Ç¨</td>
                    <td><span class="status-dot bg-${color}"></span><span class="small">${x.estado}</span></td>
                    <td class="text-end pe-3">
                        <button class="btn btn-sm btn-light text-primary py-0" onclick="prepararEditar(${x.id})"><i class="bi bi-pencil-fill"></i></button>
                        <button class="btn btn-sm btn-light text-danger py-0 ms-1" onclick="borrar(${x.id})"><i class="bi bi-trash-fill"></i></button>
                    </td>
                </tr>`;

                tAsignar.innerHTML += `<tr>
                    <td class="ps-3"><div class="fw-bold text-truncate" style="max-width:140px">${x.modelo}</div><small class="text-muted">${x.numero_activo}</small></td>
                    <td><code class="small">${x.serie}</code></td>
                    <td><span class="badge bg-secondary rounded-pill fw-normal">${x.usuario}</span></td>
                    <td class="text-end pe-3">
                        <button class="btn btn-sm btn-primary py-0 px-2" onclick="prepararAsignar(${x.id})">Asignar</button>
                        <button class="btn btn-sm btn-outline-secondary py-0 px-1 ms-1" onclick="historial(${x.id}, '${x.modelo}')"><i class="bi bi-clock"></i></button>
                    </td>
                </tr>`;
            });
        }

        function prepararEditar(id) {
            const item = globalData.find(x => x.id === id);
            if (!item) return;

            document.getElementById('edit-id').value = item.id;
            document.getElementById('edit-n-activo').value = item.numero_activo;
            document.getElementById('edit-cat').value = item.categoria;
            document.getElementById('edit-mod').value = item.modelo;
            document.getElementById('edit-ser').value = item.serie;
            document.getElementById('edit-del').value = item.delegacion;
            document.getElementById('edit-coste').value = item.coste;
            document.getElementById('edit-fecha').value = item.fecha_compra;

            const qr = document.getElementById("qr-code"); qr.innerHTML = "";
            new QRCode(qr, { text: `${window.location.origin}/?buscar=${item.serie}`, width: 64, height: 64 }); // QR M√°s peque√±o para que quepa

            new bootstrap.Modal(document.getElementById('modalEditar')).show();
        }

        async function confirmarEdicion() {
            const id = document.getElementById('edit-id').value;
            const body = {
                categoria: document.getElementById('edit-cat').value, modelo: document.getElementById('edit-mod').value,
                serie: document.getElementById('edit-ser').value, numero_activo: document.getElementById('edit-n-activo').value,
                delegacion: document.getElementById('edit-del').value, coste: parseFloat(document.getElementById('edit-coste').value) || 0,
                fecha_compra: document.getElementById('edit-fecha').value
            };
            const res = await fetch(`/actualizar/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if (res.ok) { bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide(); cargar(); Swal.fire({ icon: 'success', title: 'Guardado', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 }); }
        }

        async function guardar() {
            const body = {
                categoria: document.getElementById('cat').value, modelo: document.getElementById('mod').value, serie: document.getElementById('ser').value,
                numero_activo: document.getElementById('n-activo').value, delegacion: document.getElementById('del').value || 'Central',
                coste: parseFloat(document.getElementById('coste').value) || 0, fecha_compra: document.getElementById('fecha-compra').value || ''
            };
            if (!body.modelo || !body.serie) return Swal.fire('Error', 'Faltan datos', 'warning');

            const res = await fetch('/crear', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            const json = await res.json();
            if (json.status === 'success') { toggleForm(); cargar(); Swal.fire({ icon: 'success', title: 'Creado', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 }); }
            else Swal.fire('Error', json.message, 'error');
        }

        function prepararAsignar(id) { document.getElementById('id-asignar-temp').value = id; new bootstrap.Modal(document.getElementById('modalAsignar')).show(); }
        async function confirmarAsignacion() {
            const id = document.getElementById('id-asignar-temp').value; const u = document.getElementById('nombre-usuario-modal').value;
            if (!u) return;
            const res = await fetch('/asignar', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, usuario: u }) });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('modalAsignar')).hide();
                Swal.fire({ title: 'Asignado', text: '¬øDescargar Acta?', icon: 'success', showCancelButton: true, confirmButtonText: 'S√≠' }).then((r) => { if (r.isConfirmed) generarPDF(u); });
                cargar();
            }
        }

        async function marcarReparacion() {
            const { value: text } = await Swal.fire({ input: 'text', inputLabel: 'Motivo', showCancelButton: true });
            if (text) {
                const id = document.getElementById('edit-id').value;
                await fetch('/estado', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, estado: 'En Reparaci√≥n', nota: text }) });
                bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide(); cargar();
            }
        }

        function borrar(id) {
            Swal.fire({ title: '¬øArchivar?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠' }).then(async (result) => {
                if (result.isConfirmed) { await fetch(`/eliminar/${id}`, { method: 'DELETE' }); cargar(); }
            })
        }

        function renderGraficos(data) {
            const ctx1 = document.getElementById('chartCategoria').getContext('2d');
            const ctx2 = document.getElementById('chartDelegacion').getContext('2d');
            const cats = {}, dels = {};
            data.forEach(x => { cats[x.categoria] = (cats[x.categoria] || 0) + 1; dels[x.delegacion] = (dels[x.delegacion] || 0) + 1; });

            if (chart1) chart1.destroy();
            chart1 = new Chart(ctx1, { type: 'bar', data: { labels: Object.keys(cats), datasets: [{ label: 'Stock', data: Object.values(cats), backgroundColor: '#0d6efd', borderRadius: 4, barThickness: 20 }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });

            if (chart2) chart2.destroy();
            chart2 = new Chart(ctx2, { type: 'doughnut', data: { labels: Object.keys(dels), datasets: [{ data: Object.values(dels), backgroundColor: ['#6610f2', '#0dcaf0', '#20c997'] }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } } });
        }

        function cargarActividad() {
            fetch('/actividad').then(r => r.json()).then(data => {
                const f = document.getElementById('feed-actividad'); f.innerHTML = '';
                data.forEach(x => f.innerHTML += `<div class="mb-2 pb-2 border-bottom border-light"><small class="text-muted" style="font-size:0.75rem">${new Date(x.fecha).toLocaleDateString()}</small><br><strong>${x.modelo}</strong> <span class="text-muted small">${x.detalle}</span></div>`);
            });
        }

        function generarPDF(u) { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text("ACTA DE ENTREGA", 105, 20, null, null, "center"); doc.text(`Responsable: ${u}`, 20, 40); doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 50); doc.save(`Acta_${u}.pdf`); }
        function imprimirQR() { const c = document.getElementById('qr-code').innerHTML, s = document.getElementById('edit-ser').value; const w = window.open('', '', 'height=300,width=300'); w.document.write(`<html><body style="display:flex;justify-content:center;align-items:center;height:100vh;flex-direction:column">${c}<div style="font-family:monospace;margin-top:10px;font-weight:bold">${s}</div></body></html>`); w.document.close(); setTimeout(() => w.print(), 500); }
        function imprimirFichaTecnica() { const id = document.getElementById('edit-id').value; fetch(`/historial/${id}`).then(r => r.json()).then(h => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text(`FICHA T√âCNICA`, 20, 20); doc.autoTable({ startY: 30, head: [['Fecha', 'Detalle']], body: h.map(x => [new Date(x.fecha).toLocaleString(), x.detalle]) }); doc.save('ficha.pdf'); }); }
        function subirExcel(i) { let fd = new FormData(); fd.append("file", i.files[0]); fetch('/importar', { method: 'POST', body: fd }).then(r => r.json()).then(res => { Swal.fire('Importado', res.message, 'success'); cargar(); }); }
        function historial(id, mod) { fetch(`/historial/${id}`).then(r => r.json()).then(d => { document.getElementById('tituloHistorial').innerText = `Historial: ${mod}`; let h = '<ul class="list-unstyled mb-0">'; d.forEach(x => h += `<li class="mb-2"><small class="text-primary fw-bold">${new Date(x.fecha).toLocaleDateString()}</small><div class="small">${x.detalle}</div></li>`); document.getElementById('cuerpoHistorial').innerHTML = h + '</ul>'; new bootstrap.Modal(document.getElementById('modalHistorial')).show(); }) }
        function filtrar() { const v = document.getElementById('buscador').value.toLowerCase(); document.querySelectorAll('#lista-asignar tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none'); }

        cargar();
    </script>
</body>

</html>