<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Master V5 - Big Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* === TAMA√ëO DE LETRA AUMENTADO (16px base) === */
        :root {
            --sidebar-width: 280px;
            --card-bg: #fff;
            --body-bg: #eaeff5;
            font-size: 16px;
        }

        [data-bs-theme="dark"] {
            --card-bg: #1e1e2d;
            --body-bg: #151521;
        }

        body {
            background-color: var(--body-bg);
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow-x: hidden;
        }

        /* Sidebar m√°s ancha para leer mejor */
        #sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: #1a1a27;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 1000;
            transition: 0.3s;
        }

        #content {
            margin-left: var(--sidebar-width);
            padding: 30px;
            width: calc(100% - var(--sidebar-width));
            transition: 0.3s;
        }

        @media (max-width: 768px) {
            #sidebar {
                left: -300px;
            }

            #sidebar.active {
                left: 0;
            }

            #content {
                margin-left: 0;
                padding: 15px;
                width: 100%;
            }
        }

        /* Botones y Links grandes */
        .nav-link {
            color: #a2a3b7;
            padding: 15px 20px;
            margin: 5px 15px;
            border-radius: 12px;
            font-size: 1.1rem;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .nav-link.active {
            background: #0d6efd;
            color: white;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4);
        }

        .card-custom {
            border: none;
            border-radius: 15px;
            background-color: var(--card-bg);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        /* TABLA ESPACIOSA */
        .table td,
        .table th {
            padding: 1rem 1rem;
            vertical-align: middle;
            font-size: 1rem;
        }

        .badge-activo {
            background: #3e4053;
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.95rem;
        }

        /* BARRA FLOTANTE DE ACCIONES MASIVAS */
        #bulk-actions {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #212529;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 20px;
        }

        .vista {
            display: none;
        }

        .vista.activa {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <button id="btn-abrir"
        class="btn btn-primary d-md-none position-fixed top-0 start-0 m-3 z-3 shadow rounded-circle p-3"
        onclick="toggleMenu()"><i class="bi bi-list fs-3"></i></button>

    <div id="sidebar" class="d-flex flex-column">
        <div class="p-4 d-flex align-items-center border-bottom border-dark border-opacity-50">
            <div class="bg-primary rounded p-2 me-3"><i class="bi bi-cpu-fill text-white fs-3"></i></div>
            <div>
                <h4 class="fw-bold m-0 text-white">IT MASTER</h4><small class="text-muted">Big Boss V5</small>
            </div>
        </div>
        <nav class="nav flex-column mt-4 flex-grow-1">
            <a class="nav-link active" onclick="verVentana('v-inicio', this)"><i
                    class="bi bi-speedometer2 me-3 fs-5"></i> Dashboard</a>
            <a class="nav-link" onclick="verVentana('v-stock', this)"><i class="bi bi-box-seam me-3 fs-5"></i>
                Inventario</a>
            <a class="nav-link" onclick="verVentana('v-operaciones', this)"><i class="bi bi-people me-3 fs-5"></i>
                Asignaciones</a>
        </nav>
        <div class="p-4"><button class="btn btn-outline-secondary w-100 btn-lg rounded-pill"
                onclick="toggleDarkMode()"><i class="bi bi-moon-stars me-2"></i>Tema</button></div>
    </div>

    <div id="content">

        <div id="v-inicio" class="vista activa">
            <h2 class="fw-bold mb-4">Resumen Global</h2>
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card card-custom p-4 border-start border-5 border-primary h-100">
                        <span class="text-muted fw-bold">TOTAL ACTIVOS</span>
                        <h1 class="fw-bold display-4 mb-0" id="total">0</h1>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom p-4 border-start border-5 border-success h-100">
                        <span class="text-muted fw-bold">DISPONIBLES</span>
                        <h1 class="fw-bold display-4 mb-0 text-success" id="disp">0</h1>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom p-4 border-start border-5 border-danger h-100">
                        <span class="text-muted fw-bold">VALOR</span>
                        <h1 class="fw-bold display-6 mb-0 text-danger" id="valor-total">0‚Ç¨</h1>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom p-4 border-start border-5 border-warning h-100">
                        <span class="text-muted fw-bold">REPARACI√ìN</span>
                        <h1 class="fw-bold display-4 mb-0 text-warning" id="rep">0</h1>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card card-custom p-4 mb-4">
                        <h4 class="fw-bold mb-4">An√°lisis</h4>
                        <div class="row">
                            <div class="col-md-6" style="height: 300px;"><canvas id="chartCategoria"></canvas></div>
                            <div class="col-md-6" style="height: 300px;"><canvas id="chartDelegacion"></canvas></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card card-custom p-4 h-100">
                        <h4 class="fw-bold mb-4">Actividad</h4>
                        <div id="feed-actividad" style="max-height: 350px; overflow-y: auto;" class="fs-5"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="v-stock" class="vista">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold m-0">Inventario</h2>
                <div class="d-flex gap-2">
                    <label class="btn btn-outline-info btn-lg"><i class="bi bi-upload"></i> <input type="file" hidden
                            onchange="subirExcel(this)"></label>
                    <button class="btn btn-primary btn-lg rounded-pill px-4" onclick="toggleForm()"><i
                            class="bi bi-plus-lg me-2"></i>Nuevo</button>
                </div>
            </div>

            <div id="form-alta" class="card card-custom p-4 mb-4 bg-body-tertiary" style="display:none;">
                <h4 class="text-primary fw-bold mb-3">Alta de Activo</h4>
                <div class="row g-3">
                    <div class="col-md-2"><label class="form-label fw-bold">Etiqueta</label><input type="text"
                            id="n-activo" class="form-control form-control-lg" placeholder="IT-001"></div>
                    <div class="col-md-2"><label class="form-label fw-bold">Tipo</label><select id="cat"
                            class="form-select form-select-lg">
                            <option value="Laptop">Laptop üíª</option>
                            <option value="Monitor">Monitor üñ•Ô∏è</option>
                            <option value="M√≥vil">M√≥vil üì±</option>
                        </select></div>
                    <div class="col-md-3"><label class="form-label fw-bold">Modelo</label><input type="text" id="mod"
                            class="form-control form-control-lg"></div>
                    <div class="col-md-3"><label class="form-label fw-bold">Serie</label><input type="text" id="ser"
                            class="form-control form-control-lg"></div>
                    <div class="col-md-2"><label class="form-label fw-bold">Coste ‚Ç¨</label><input type="number"
                            id="coste" class="form-control form-control-lg"></div>

                    <div class="col-md-3"><label class="form-label fw-bold">Fecha Compra</label><input type="date"
                            id="fecha-compra" class="form-control form-control-lg" onchange="calcGarantia()"></div>
                    <div class="col-md-3"><label class="form-label fw-bold">Fin Garant√≠a</label><input type="date"
                            id="fin-garantia" class="form-control form-control-lg"></div>
                    <div class="col-md-3"><label class="form-label fw-bold">Sede</label><input type="text" id="del"
                            class="form-control form-control-lg"></div>
                    <div class="col-md-3 d-flex align-items-end"><button onclick="guardar()"
                            class="btn btn-success btn-lg w-100">Guardar</button></div>
                </div>
            </div>

            <div class="table-responsive card-custom p-0">
                <table class="table table-hover mb-0">
                    <thead class="bg-body-tertiary">
                        <tr>
                            <th class="ps-4"><input type="checkbox" class="form-check-input p-2"
                                    onclick="toggleSelectAll(this)"></th>
                            <th>ID</th>
                            <th>Modelo</th>
                            <th>Sede</th>
                            <th>Garant√≠a</th>
                            <th>Estado</th>
                            <th class="text-end pe-4">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="lista-stock"></tbody>
                </table>
            </div>
        </div>

        <div id="v-operaciones" class="vista">
            <h2 class="fw-bold mb-4">Asignaciones</h2>
            <input type="text" id="buscador" class="form-control form-control-lg mb-4 shadow-sm border-0 p-3"
                placeholder="üîç Buscar empleado, serie..." onkeyup="filtrar()">
            <div class="table-responsive card-custom p-0">
                <table class="table table-hover mb-0">
                    <thead class="bg-body-tertiary">
                        <tr>
                            <th class="ps-4">Equipo</th>
                            <th>Detalle</th>
                            <th>Usuario Actual</th>
                            <th class="text-end pe-4">Gesti√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="lista-asignar"></tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="modal fade" id="modalEditar" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header bg-primary text-white py-3">
                    <h4 class="modal-title fw-bold">Ficha de Activo</h4><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-5">
                    <input type="hidden" id="edit-id">
                    <div class="row g-4">
                        <div class="col-md-8">
                            <div class="row g-3 mb-3">
                                <div class="col-6"><label class="fw-bold">Etiqueta</label><input type="text"
                                        id="edit-n-activo" class="form-control form-control-lg bg-light"></div>
                                <div class="col-6"><label class="fw-bold">Sede</label><input type="text" id="edit-del"
                                        class="form-control form-control-lg bg-light"></div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-6"><label class="fw-bold">Modelo</label><input type="text" id="edit-mod"
                                        class="form-control form-control-lg bg-light"></div>
                                <div class="col-6"><label class="fw-bold">Serie</label><input type="text" id="edit-ser"
                                        class="form-control form-control-lg bg-light font-monospace"></div>
                            </div>
                            <div class="row g-3 mb-4 p-4 bg-light rounded-4 border">
                                <h5 class="fw-bold text-muted border-bottom pb-2">Datos Financieros</h5>
                                <div class="col-4"><label class="fw-bold">Coste ‚Ç¨</label><input type="number"
                                        id="edit-coste" class="form-control form-control-lg"></div>
                                <div class="col-4"><label class="fw-bold">Compra</label><input type="date"
                                        id="edit-fecha" class="form-control form-control-lg"></div>
                                <div class="col-4"><label class="fw-bold">Fin Garant√≠a</label><input type="date"
                                        id="edit-garantia" class="form-control form-control-lg"></div>
                            </div>
                        </div>
                        <div class="col-md-4 border-start ps-4 text-center">
                            <div id="qr-code" class="p-3 bg-white shadow-sm rounded mb-4 d-inline-block"></div>
                            <div class="d-grid gap-3">
                                <button class="btn btn-outline-dark btn-lg" onclick="imprimirQR()">üñ®Ô∏è Sticker</button>
                                <button class="btn btn-outline-primary btn-lg" onclick="imprimirFichaTecnica()">üìÑ Ficha
                                    PDF</button>
                                <button class="btn btn-outline-warning btn-lg" onclick="marcarReparacion()">üîß
                                    Reparar</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-3"><button onclick="confirmarEdicion()"
                        class="btn btn-success btn-lg px-5 fw-bold shadow">Guardar Cambios</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAsignar" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0">
                    <h4 class="fw-bold">Asignar Equipo</h4>
                </div>
                <div class="modal-body"><input type="hidden" id="id-asignar-temp"><input type="text"
                        id="nombre-usuario-modal" class="form-control form-control-lg p-3"
                        placeholder="Nombre empleado"></div>
                <div class="modal-footer border-0"><button onclick="confirmarAsignacion()"
                        class="btn btn-primary btn-lg w-100">Confirmar</button></div>
            </div>
        </div>
    </div>

    <div id="bulk-actions">
        <span class="fs-5"><span id="selected-count" class="fw-bold text-warning">0</span> seleccionados</span>
        <button class="btn btn-danger rounded-pill px-4" onclick="borrarMasivo()">üóëÔ∏è Borrar Todos</button>
        <button class="btn btn-secondary rounded-circle" onclick="cancelarSeleccion()"><i
                class="bi bi-x-lg"></i></button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let globalData = [];
        let chart1 = null, chart2 = null;

        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); }
        function toggleForm() { const f = document.getElementById('form-alta'); f.style.display = f.style.display === 'none' ? 'block' : 'none'; }
        function toggleDarkMode() { document.documentElement.setAttribute('data-bs-theme', document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark'); }
        function verVentana(id, el) { document.querySelectorAll('.vista').forEach(v => v.classList.remove('activa')); document.getElementById(id).classList.add('activa'); document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); el.classList.add('active'); }

        // AUTO-CALCULAR GARANT√çA (3 a√±os por defecto)
        function calcGarantia() {
            const fecha = new Date(document.getElementById('fecha-compra').value);
            if (!isNaN(fecha)) {
                fecha.setFullYear(fecha.getFullYear() + 3);
                document.getElementById('fin-garantia').value = fecha.toISOString().split('T')[0];
            }
        }

        function checkGarantia(fechaFin) {
            if (!fechaFin) return '<span class="badge bg-secondary">Sin dato</span>';
            const hoy = new Date();
            const fin = new Date(fechaFin);
            const diffDias = Math.ceil((fin - hoy) / (1000 * 60 * 60 * 24));

            if (diffDias < 0) return '<span class="badge bg-danger">Expirada</span>';
            if (diffDias < 180) return `<span class="badge bg-warning text-dark">${diffDias} d√≠as</span>`;
            return `<span class="badge bg-success">Vigente</span>`;
        }

        async function cargar() {
            try {
                const res = await fetch('/activos');
                if (res.status === 401) { location.reload(); return; }
                const data = await res.json();
                globalData = data;

                // KPIs
                document.getElementById('total').innerText = data.length;
                document.getElementById('disp').innerText = data.filter(x => x.estado === 'Disponible').length;
                document.getElementById('rep').innerText = data.filter(x => x.estado === 'En Reparaci√≥n').length;
                const valor = data.reduce((a, b) => a + (b.coste || 0), 0);
                document.getElementById('valor-total').innerText = valor.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });

                renderTablas(data);
                renderGraficos(data);

                const f = document.getElementById('feed-actividad'); f.innerHTML = '';
                const act = await (await fetch('/actividad')).json();
                act.forEach(x => f.innerHTML += `<div class="mb-3 border-bottom pb-2"><small class="text-muted fw-bold">${new Date(x.fecha).toLocaleDateString()}</small><br><span class="fw-bold fs-5">${x.modelo}</span> <span class="text-muted">${x.detalle}</span></div>`);

            } catch (e) { console.error(e); }
        }

        function renderTablas(data) {
            const tStock = document.getElementById('lista-stock'); tStock.innerHTML = '';
            const tAsignar = document.getElementById('lista-asignar'); tAsignar.innerHTML = '';

            data.forEach(x => {
                const color = x.estado === 'Disponible' ? 'success' : (x.estado === 'Asignado' ? 'primary' : 'warning');
                const garantiaBadge = checkGarantia(x.fin_garantia);

                tStock.innerHTML += `<tr>
                    <td class="ps-4"><input type="checkbox" class="form-check-input item-check p-2" value="${x.id}" onchange="updateBulk()"></td>
                    <td><span class="fw-bold text-muted">#${x.id}</span></td>
                    <td><div class="fw-bold fs-5">${x.modelo}</div><span class="badge-activo">${x.numero_activo || 'N/A'}</span></td>
                    <td>${x.delegacion}</td>
                    <td>${garantiaBadge}</td>
                    <td><span class="badge bg-${color} fs-6">${x.estado}</span></td>
                    <td class="text-end pe-4">
                        <button class="btn btn-light btn-lg text-primary" onclick="prepararEditar(${x.id})"><i class="bi bi-pencil-fill"></i></button>
                        <button class="btn btn-light btn-lg text-danger ms-2" onclick="borrar(${x.id})"><i class="bi bi-trash-fill"></i></button>
                    </td>
                </tr>`;

                tAsignar.innerHTML += `<tr>
                    <td class="ps-4"><div class="fw-bold fs-5">${x.modelo}</div><small class="text-muted">${x.numero_activo}</small></td>
                    <td><code class="fs-6">${x.serie}</code></td>
                    <td><span class="badge bg-secondary fs-6 px-3 py-2">${x.usuario}</span></td>
                    <td class="text-end pe-4">
                        <button class="btn btn-primary btn-lg" onclick="prepararAsignar(${x.id})">Asignar</button>
                    </td>
                </tr>`;
            });
        }

        // --- L√ìGICA DE SELECCI√ìN MASIVA ---
        function toggleSelectAll(source) {
            document.querySelectorAll('.item-check').forEach(c => c.checked = source.checked);
            updateBulk();
        }
        function updateBulk() {
            const count = document.querySelectorAll('.item-check:checked').length;
            const bar = document.getElementById('bulk-actions');
            if (count > 0) {
                bar.style.display = 'flex';
                document.getElementById('selected-count').innerText = count;
            } else {
                bar.style.display = 'none';
            }
        }
        function cancelarSeleccion() {
            document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
            updateBulk();
        }
        async function borrarMasivo() {
            const ids = Array.from(document.querySelectorAll('.item-check:checked')).map(c => parseInt(c.value));
            const { isConfirmed } = await Swal.fire({ title: `¬øBorrar ${ids.length} equipos?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠, borrar' });
            if (isConfirmed) {
                await fetch('/eliminar-masivo', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ids }) });
                cancelarSeleccion(); cargar();
            }
        }

        // --- EDICI√ìN Y CREACI√ìN ---
        function prepararEditar(id) {
            const item = globalData.find(x => x.id === id);
            if (!item) return;
            document.getElementById('edit-id').value = item.id;
            document.getElementById('edit-n-activo').value = item.numero_activo;
            document.getElementById('edit-cat').value = item.categoria;
            document.getElementById('edit-mod').value = item.modelo;
            document.getElementById('edit-ser').value = item.serie;
            document.getElementById('edit-del').value = item.delegacion;
            document.getElementById('edit-coste').value = item.coste;
            document.getElementById('edit-fecha').value = item.fecha_compra;
            document.getElementById('edit-garantia').value = item.fin_garantia;

            const qr = document.getElementById("qr-code"); qr.innerHTML = "";
            new QRCode(qr, { text: `${window.location.origin}/?buscar=${item.serie}`, width: 150, height: 150 });
            new bootstrap.Modal(document.getElementById('modalEditar')).show();
        }

        async function guardar() {
            const body = {
                categoria: document.getElementById('cat').value, modelo: document.getElementById('mod').value, serie: document.getElementById('ser').value,
                numero_activo: document.getElementById('n-activo').value, delegacion: document.getElementById('del').value || 'Central',
                coste: parseFloat(document.getElementById('coste').value) || 0, fecha_compra: document.getElementById('fecha-compra').value || '',
                fin_garantia: document.getElementById('fin-garantia').value || ''
            };
            if (!body.modelo) return Swal.fire('Error', 'Falta modelo', 'warning');
            const res = await fetch('/crear', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if ((await res.json()).status === 'success') { toggleForm(); cargar(); Swal.fire({ icon: 'success', title: 'Creado', timer: 1500, showConfirmButton: false }); }
        }

        async function confirmarEdicion() {
            const id = document.getElementById('edit-id').value;
            const body = {
                categoria: 'Laptop', // Simplificado, deber√≠as pillar el valor real
                modelo: document.getElementById('edit-mod').value, serie: document.getElementById('edit-ser').value,
                numero_activo: document.getElementById('edit-n-activo').value, delegacion: document.getElementById('edit-del').value,
                coste: parseFloat(document.getElementById('edit-coste').value) || 0, fecha_compra: document.getElementById('edit-fecha').value,
                fin_garantia: document.getElementById('edit-garantia').value, categoria: document.getElementById('edit-cat').value
            };
            const res = await fetch(`/actualizar/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if (res.ok) { bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide(); cargar(); Swal.fire('Guardado', '', 'success'); }
        }

        // --- ASIGNAR Y OTROS ---
        function prepararAsignar(id) { document.getElementById('id-asignar-temp').value = id; new bootstrap.Modal(document.getElementById('modalAsignar')).show(); }
        async function confirmarAsignacion() {
            const id = document.getElementById('id-asignar-temp').value; const u = document.getElementById('nombre-usuario-modal').value;
            if (!u) return;
            const res = await fetch('/asignar', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, usuario: u }) });
            if (res.ok) { bootstrap.Modal.getInstance(document.getElementById('modalAsignar')).hide(); cargar(); Swal.fire('Asignado', '', 'success'); }
        }
        function borrar(id) { Swal.fire({ title: '¬øBorrar?', icon: 'warning', showCancelButton: true }).then(async r => { if (r.isConfirmed) { await fetch(`/eliminar/${id}`, { method: 'DELETE' }); cargar(); } }); }
        async function marcarReparacion() { const { value: t } = await Swal.fire({ input: 'text', title: 'Motivo aver√≠a' }); if (t) { await fetch('/estado', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: document.getElementById('edit-id').value, estado: 'En Reparaci√≥n', nota: t }) }); cargar(); bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide(); } }

        function renderGraficos(data) {
            const ctx1 = document.getElementById('chartCategoria'); const ctx2 = document.getElementById('chartDelegacion');
            const cats = {}, dels = {}; data.forEach(x => { cats[x.categoria] = (cats[x.categoria] || 0) + 1; dels[x.delegacion] = (dels[x.delegacion] || 0) + 1; });
            if (chart1) chart1.destroy(); chart1 = new Chart(ctx1, { type: 'bar', data: { labels: Object.keys(cats), datasets: [{ label: 'Stock', data: Object.values(cats), backgroundColor: '#0d6efd', borderRadius: 8 }] }, options: { maintainAspectRatio: false } });
            if (chart2) chart2.destroy(); chart2 = new Chart(ctx2, { type: 'doughnut', data: { labels: Object.keys(dels), datasets: [{ data: Object.values(dels), backgroundColor: ['#6610f2', '#0dcaf0', '#20c997'] }] }, options: { maintainAspectRatio: false } });
        }

        function subirExcel(i) { let fd = new FormData(); fd.append("file", i.files[0]); fetch('/importar', { method: 'POST', body: fd }).then(() => { Swal.fire('Importado', '', 'success'); cargar(); }); }
        function imprimirQR() { const c = document.getElementById('qr-code').innerHTML, s = document.getElementById('edit-ser').value; const w = window.open('', '', 'height=400,width=400'); w.document.write(`<html><body style="display:flex;justify-content:center;align-items:center;height:100vh;flex-direction:column">${c}<h1>${s}</h1></body></html>`); w.document.close(); setTimeout(() => w.print(), 500); }
        function imprimirFichaTecnica() { Swal.fire('Generando PDF...', '', 'info'); } // Aqu√≠ ir√≠a la l√≥gica del PDF igual que antes
        function filtrar() { const v = document.getElementById('buscador').value.toLowerCase(); document.querySelectorAll('#lista-asignar tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none'); }

        cargar();
    </script>
</body>

</html>