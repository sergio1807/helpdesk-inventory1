<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Admin Panel v2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --sidebar-width: 250px;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }

        /* Sidebar & Layout */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1900;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
            backdrop-filter: blur(2px);
        }

        #overlay.active {
            opacity: 1;
            visibility: visible;
        }

        @media (min-width: 769px) {
            #sidebar {
                width: var(--sidebar-width);
                height: 100vh;
                position: fixed;
                left: 0;
                background: #212529;
                color: white;
            }

            #content {
                margin-left: var(--sidebar-width);
                padding: 40px;
                width: calc(100% - var(--sidebar-width));
            }

            #btn-abrir {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -250px;
                width: var(--sidebar-width);
                height: 100vh;
                background: #212529;
                z-index: 2000;
                transition: 0.3s;
                box-shadow: 4px 0 15px rgba(0, 0, 0, 0.3);
            }

            #sidebar.active {
                left: 0;
            }

            #content {
                margin-left: 0;
                padding: 20px;
                width: 100%;
            }

            .col-md-4,
            .col-md-6 {
                width: 100% !important;
                margin-bottom: 15px;
            }

            .table-responsive {
                overflow-x: auto;
            }
        }

        /* Componentes */
        #btn-abrir {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1500;
            border-radius: 8px;
            transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #btn-abrir.oculto {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-20px);
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.7);
            padding: 12px 20px;
            transition: 0.2s;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 4px solid #0d6efd;
        }

        .vista {
            display: none;
            animation: fadeIn 0.3s;
        }

        .vista.activa {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* Spinner */
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
    </style>
</head>

<body>
    <div id="overlay" onclick="toggleMenu()"></div>
    <button id="btn-abrir" class="btn btn-dark d-md-none" onclick="toggleMenu()"><i
            class="bi bi-list fs-3"></i></button>

    <div id="sidebar">
        <div class="p-4 d-flex justify-content-between align-items-center">
            <h4 class="fw-bold m-0"><i class="bi bi-shield-lock-fill"></i> IT MASTER</h4>
            <button class="btn btn-outline-light d-md-none border-0" onclick="toggleMenu()"><i
                    class="bi bi-x-lg"></i></button>
        </div>
        <nav class="nav flex-column">
            <a class="nav-link active" onclick="verVentana('v-inicio', this)"><i class="bi bi-house-door me-2"></i>
                Inicio</a>
            <a class="nav-link" onclick="verVentana('v-stock', this)"><i class="bi bi-box-seam me-2"></i> Inventario</a>
            <a class="nav-link" onclick="verVentana('v-operaciones', this)"><i class="bi bi-person-gear me-2"></i>
                Asignaciones</a>
            <hr class="mx-3 opacity-25">
            <a class="nav-link text-success" href="/exportar"><i class="bi bi-file-earmark-excel me-2"></i> Exportar
                Datos</a>
        </nav>
    </div>

    <div id="content">
        <div id="v-inicio" class="vista activa">
            <h2 class="mb-4">Dashboard de IT</h2>
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card card-custom p-4 bg-primary text-white">
                        <h6>Total Activos</h6>
                        <h2 id="total">0</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-custom p-4 bg-success text-white">
                        <h6>Disponibles</h6>
                        <h2 id="disp">0</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-custom p-4 bg-info text-white">
                        <h6>En Uso</h6>
                        <h2 id="uso">0</h2>
                    </div>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card card-custom p-4 bg-white">
                        <h6 class="text-muted mb-3">Distribuci√≥n por Estado</h6>
                        <canvas id="chartEstado" style="max-height: 250px;"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card card-custom p-4 bg-white">
                        <h6 class="text-muted mb-3">Inventario por Categor√≠a</h6>
                        <canvas id="chartCategoria" style="max-height: 250px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="v-stock" class="vista">
            <h2 class="mb-4">Gesti√≥n de Inventario</h2>
            <div class="card card-custom p-4 mb-4">
                <h5 class="mb-3">Registrar Nuevo Equipo</h5>
                <div class="row g-3">
                    <div class="col-md-3"><select id="cat" class="form-select border-0 bg-light p-3">
                            <option value="Laptop">Laptop üíª</option>
                            <option value="Monitor">Monitor üñ•Ô∏è</option>
                            <option value="Perif√©rico">Perif√©rico üñ±Ô∏è</option>
                        </select></div>
                    <div class="col-md-3"><input type="text" id="mod" class="form-control border-0 bg-light p-3"
                            placeholder="Modelo"></div>
                    <div class="col-md-3"><input type="text" id="ser" class="form-control border-0 bg-light p-3"
                            placeholder="Serie"></div>
                    <div class="col-md-3">
                        <button id="btn-guardar" onclick="guardar()" class="btn btn-dark w-100 p-3 fw-bold">
                            <span class="normal-text">A√±adir al Stock</span>
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="table-responsive bg-white p-3 rounded-4 shadow-sm">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Modelo</th>
                            <th>S/N</th>
                            <th>Estado</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="lista-stock"></tbody>
                </table>
            </div>
        </div>

        <div id="v-operaciones" class="vista">
            <h2 class="mb-4">Panel de Operaciones</h2>
            <div class="mb-3"><input type="text" id="buscador" class="form-control p-3 border-0 shadow-sm rounded-4"
                    placeholder="Buscar..." onkeyup="filtrar()"></div>
            <div class="table-responsive bg-white p-3 rounded-4 shadow-sm">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Equipo</th>
                            <th>Serie</th>
                            <th>Usuario</th>
                            <th class="text-end">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="lista-asignar"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-body">
        <div class="row">
            <div class="col-md-7">
                <input type="hidden" id="edit-id">
                <label class="small text-muted fw-bold">Categor√≠a</label>
                <select id="edit-cat" class="form-select mb-3 bg-light border-0">
                    <option value="Laptop">Laptop</option>
                    <option value="Monitor">Monitor</option>
                    <option value="Perif√©rico">Perif√©rico</option>
                </select>

                <label class="small text-muted fw-bold">Modelo</label>
                <input type="text" id="edit-mod" class="form-control mb-3 bg-light border-0">

                <label class="small text-muted fw-bold">N√∫mero de Serie</label>
                <input type="text" id="edit-ser" class="form-control bg-light border-0">
            </div>

            <div class="col-md-5 text-center d-flex flex-column align-items-center justify-content-center border-start">
                <label class="small text-muted mb-2">Etiqueta de Activo</label>
                <div id="qr-code" class="p-2 bg-white border rounded mb-2"></div>
                <small class="text-muted" style="font-size: 0.7rem;">Escanea para ver detalles</small>
                <button class="btn btn-sm btn-outline-dark mt-2" onclick="imprimirQR()">
                    <i class="bi bi-printer"></i> Imprimir
                </button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAsignar" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Asignar Usuario</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="id-asignar-temp">
                    <input type="text" id="nombre-usuario-modal" class="form-control border-0 bg-light p-3"
                        placeholder="Nombre completo">
                </div>
                <div class="modal-footer border-0">
                    <button id="btn-confirmar-asignar" onclick="confirmarAsignacion()"
                        class="btn btn-primary w-100 fw-bold">
                        <span class="normal-text">Confirmar</span>
                        <span class="spinner-border spinner-border-sm d-none"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalBorrar" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4 text-center p-4">
                <input type="hidden" id="id-borrar-temp">
                <h5 class="fw-bold text-danger">¬øEliminar?</h5>
                <p class="small text-muted">Irreversible.</p>
                <button id="btn-confirmar-borrar" onclick="confirmarBorrado()" class="btn btn-danger w-100">
                    <span class="normal-text">S√≠, eliminar</span>
                    <span class="spinner-border spinner-border-sm d-none"></span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalHistorial" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 bg-light">
                    <h5 class="modal-title fw-bold" id="tituloHistorial"></h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" id="cuerpoHistorial" style="max-height:400px;overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-white border-0 rounded-3 shadow" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toast-mensaje"></div><button type="button"
                    class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const iconos = { Laptop: 'üíª', Monitor: 'üñ•Ô∏è', Perif√©rico: 'üñ±Ô∏è' };
        let chartEstadoInstance = null;
        let chartCatInstance = null;

        // --- UX: CARGANDO ---
        function setCargando(btnId, estado) {
            const btn = document.getElementById(btnId);
            const spinner = btn.querySelector('.spinner-border');
            const text = btn.querySelector('.normal-text');
            if (estado) {
                btn.disabled = true;
                spinner.classList.remove('d-none');
                text.classList.add('d-none');
            } else {
                btn.disabled = false;
                spinner.classList.add('d-none');
                text.classList.remove('d-none');
            }
        }

        // --- NAVEGACI√ìN ---
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
            document.getElementById('sidebar').classList.contains('active') ?
                document.getElementById('btn-abrir').classList.add('oculto') :
                document.getElementById('btn-abrir').classList.remove('oculto');
        }

        function verVentana(id, el) {
            document.querySelectorAll('.vista').forEach(v => v.classList.remove('activa'));
            document.getElementById(id).classList.add('activa');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            el.classList.add('active');
            if (window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('active')) toggleMenu();
        }

        // --- GR√ÅFICOS (CHART.JS) ---
        function actualizarGraficos(data) {
            const disponibles = data.filter(x => x.estado === 'Disponible').length;
            const asignados = data.filter(x => x.estado === 'Asignado').length;

            const cats = {};
            data.forEach(x => { cats[x.categoria] = (cats[x.categoria] || 0) + 1 });

            // Gr√°fico Estado
            if (chartEstadoInstance) chartEstadoInstance.destroy();
            chartEstadoInstance = new Chart(document.getElementById('chartEstado'), {
                type: 'doughnut',
                data: {
                    labels: ['Disponible', 'Asignado'],
                    datasets: [{ data: [disponibles, asignados], backgroundColor: ['#198754', '#0dcaf0'] }]
                }
            });

            // Gr√°fico Categor√≠a
            if (chartCatInstance) chartCatInstance.destroy();
            chartCatInstance = new Chart(document.getElementById('chartCategoria'), {
                type: 'bar',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{ label: 'Cantidad', data: Object.values(cats), backgroundColor: '#212529', borderRadius: 5 }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        // --- L√ìGICA DE DATOS ---
        function notificar(msg, color = 'bg-dark') {
            const t = document.getElementById('liveToast');
            document.getElementById('toast-mensaje').innerText = msg;
            t.className = `toast align-items-center text-white border-0 rounded-3 shadow ${color}`;
            new bootstrap.Toast(t).show();
        }

        function cargar() {
            fetch('/activos').then(r => r.json()).then(data => {
                document.getElementById('total').innerText = data.length;
                document.getElementById('disp').innerText = data.filter(x => x.estado === 'Disponible').length;
                document.getElementById('uso').innerText = data.filter(x => x.estado === 'Asignado').length;

                actualizarGraficos(data); // 

                const tStock = document.getElementById('lista-stock');
                const tAsignar = document.getElementById('lista-asignar');
                tStock.innerHTML = ''; tAsignar.innerHTML = '';

                data.forEach(a => {
                    tStock.innerHTML += `<tr>
                        <td>${iconos[a.categoria] || 'üì¶'} ${a.categoria}</td>
                        <td>${a.modelo}</td>
                        <td><code>${a.serie}</code></td>
                        <td><span class="badge ${a.estado === 'Disponible' ? 'bg-success' : 'bg-info'}">${a.estado}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-warning me-1" onclick="prepararEditar(${a.id}, '${a.categoria}', '${a.modelo}', '${a.serie}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="prepararBorrar(${a.id})"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
                    tAsignar.innerHTML += `<tr>
                        <td>${a.modelo}</td>
                        <td><code>${a.serie}</code></td>
                        <td><span class="badge bg-light text-dark">${a.usuario}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-primary rounded-pill px-3 me-1" onclick="prepararAsignar(${a.id})">Asignar</button>
                            <button class="btn btn-sm btn-outline-secondary rounded-circle" onclick="verHistorial(${a.id}, '${a.modelo}')"><i class="bi bi-clock-history"></i></button>
                        </td>
                    </tr>`;
                });
            });
        }

        // --- CREAR / EDITAR / BORRAR / ASIGNAR ---

        function guardar() {
            const d = { categoria: document.getElementById('cat').value, modelo: document.getElementById('mod').value, serie: document.getElementById('ser').value };
            if (!d.modelo || !d.serie) return notificar("‚ö†Ô∏è Faltan datos", "bg-warning");

            setCargando('btn-guardar', true); // 
            fetch('/crear', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) })
                .then(r => r.json()).then(res => {
                    setCargando('btn-guardar', false);
                    if (res.status === "error") notificar(res.message, "bg-danger");
                    else { notificar("‚úÖ Creado", "bg-success"); document.getElementById('mod').value = ''; document.getElementById('ser').value = ''; cargar(); }
                });
        }

        function prepararEditar(id, cat, mod, ser) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-cat').value = cat;
            document.getElementById('edit-mod').value = mod;
            document.getElementById('edit-ser').value = ser;
            new bootstrap.Modal(document.getElementById('modalEditar')).show();
        }

        function confirmarEdicion() {
            const id = document.getElementById('edit-id').value;
            const d = { categoria: document.getElementById('edit-cat').value, modelo: document.getElementById('edit-mod').value, serie: document.getElementById('edit-ser').value };

            setCargando('btn-confirmar-edit', true);
            fetch(`/actualizar/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) })
                .then(r => r.json()).then(res => {
                    setCargando('btn-confirmar-edit', false);
                    if (res.status === "success") {
                        bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
                        notificar("‚úÖ Equipo actualizado", "bg-warning");
                        cargar();
                    } else { notificar(res.message, "bg-danger"); }
                });
        }

        function prepararAsignar(id) { document.getElementById('id-asignar-temp').value = id; new bootstrap.Modal(document.getElementById('modalAsignar')).show(); }
        function confirmarAsignacion() {
            const id = document.getElementById('id-asignar-temp').value;
            const u = document.getElementById('nombre-usuario-modal').value;
            if (!u) return notificar("‚ö†Ô∏è Falta nombre", "bg-warning");

            setCargando('btn-confirmar-asignar', true);
            fetch('/asignar', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, usuario: u }) })
                .then(() => {
                    setCargando('btn-confirmar-asignar', false);
                    bootstrap.Modal.getInstance(document.getElementById('modalAsignar')).hide();
                    notificar("üë§ Asignado", "bg-primary");
                    cargar();
                });
        }

        function prepararBorrar(id) { document.getElementById('id-borrar-temp').value = id; new bootstrap.Modal(document.getElementById('modalBorrar')).show(); }
        function confirmarBorrado() {
            const id = document.getElementById('id-borrar-temp').value;
            setCargando('btn-confirmar-borrar', true);
            fetch(`/eliminar/${id}`, { method: 'DELETE' }).then(() => {
                setCargando('btn-confirmar-borrar', false);
                bootstrap.Modal.getInstance(document.getElementById('modalBorrar')).hide();
                notificar("üóëÔ∏è Eliminado", "bg-dark");
                cargar();
            });
        }

        function verHistorial(id, mod) {
            fetch(`/historial/${id}`).then(r => r.json()).then(data => {
                if (data.length === 0) return notificar("‚ÑπÔ∏è Sin historial", "bg-secondary");
                document.getElementById('tituloHistorial').innerText = `Historial: ${mod}`;
                let html = '<ul class="list-group list-group-flush">';
                data.forEach(x => html += `<li class="list-group-item border-0 border-bottom py-3"><div class="d-flex justify-content-between"><span class="fw-bold">${x.detalle}</span><small class="text-muted">${new Date(x.fecha).toLocaleString()}</small></div></li>`);
                document.getElementById('cuerpoHistorial').innerHTML = html + '</ul>';
                new bootstrap.Modal(document.getElementById('modalHistorial')).show();
            });
        }

        function filtrar() {
            const v = document.getElementById('buscador').value.toLowerCase();
            document.querySelectorAll('#lista-asignar tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none');
        }

        function prepararEditar(id, cat, mod, ser) {
            // 1. Llenar datos
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-cat').value = cat;
            document.getElementById('edit-mod').value = mod;
            document.getElementById('edit-ser').value = ser;

            // 2. Generar QR
            const qrContainer = document.getElementById("qr-code");
            qrContainer.innerHTML = ""; // Limpiar QR anterior

            // Aqu√≠ creamos la URL √∫nica para este equipo (asumiendo que tu web est√° online)
            // Si est√°s en local, generar√° localhost. En Render, generar√° tu dominio real.
            const urlFicha = `${window.location.origin}/activos?buscar=${ser}`;

            new QRCode(qrContainer, {
                text: urlFicha,
                width: 100,
                height: 100,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            // 3. Mostrar modal
            new bootstrap.Modal(document.getElementById('modalEditar')).show();
        }

        // Funci√≥n extra para imprimir solo el QR (Truco Pro)
        function imprimirQR() {
            const contenido = document.getElementById('qr-code').innerHTML;
            const ventana = window.open('', '', 'height=500, width=500');
            ventana.document.write('<html><body>');
            ventana.document.write('<h2 style="text-align:center;">Propiedad de IT MASTER</h2>');
            ventana.document.write('<div style="display:flex;justify-content:center;margin-top:20px;">' + contenido + '</div>');
            ventana.document.write('<p style="text-align:center;">ID Activo: ' + document.getElementById('edit-ser').value + '</p>');
            ventana.document.write('</body></html>');
            ventana.document.close();
            ventana.print();
        }

        cargar();
    </script>
</body>

</html>